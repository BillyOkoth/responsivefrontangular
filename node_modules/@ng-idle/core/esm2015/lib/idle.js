/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EventEmitter, Injectable, NgZone, Optional } from '@angular/core';
import { IdleExpiry } from './idleexpiry';
import { Interrupt } from './interrupt';
import { KeepaliveSvc } from './keepalivesvc';
import { LocalStorageExpiry } from './localstorageexpiry';
/** @enum {number} */
const AutoResume = {
    /*
     * Auto resume functionality will be disabled.
     */
    disabled: 0,
    /*
     * Can resume automatically even if they are idle.
     */
    idle: 1,
    /*
     * Can only resume automatically if they are not yet idle.
     */
    notIdle: 2,
};
export { AutoResume };
AutoResume[AutoResume.disabled] = 'disabled';
AutoResume[AutoResume.idle] = 'idle';
AutoResume[AutoResume.notIdle] = 'notIdle';
/**
 * A service for detecting and responding to user idleness.
 */
export class Idle {
    /**
     * @param {?} expiry
     * @param {?} zone
     * @param {?=} keepaliveSvc
     */
    constructor(expiry, zone, keepaliveSvc) {
        this.expiry = expiry;
        this.zone = zone;
        this.idle = 20 * 60; // in seconds
        // in seconds
        this.timeoutVal = 30; // in seconds
        // in seconds
        this.autoResume = AutoResume.idle;
        this.interrupts = new Array();
        this.running = false;
        this.keepaliveEnabled = false;
        this.onIdleStart = new EventEmitter();
        this.onIdleEnd = new EventEmitter();
        this.onTimeoutWarning = new EventEmitter();
        this.onTimeout = new EventEmitter();
        this.onInterrupt = new EventEmitter();
        if (keepaliveSvc) {
            this.keepaliveSvc = keepaliveSvc;
            this.keepaliveEnabled = true;
        }
        this.setIdling(false);
    }
    /*
       * Sets the idle name for localStorage.
       * Important to set if multiple instances of Idle with LocalStorageExpiry
       * @param The name of the idle.
       */
    /**
     * @param {?} key
     * @return {?}
     */
    setIdleName(key) {
        if (this.expiry instanceof LocalStorageExpiry) {
            this.expiry.setIdleName(key);
        }
        else {
            throw new Error('Cannot set expiry key name because no LocalStorageExpiry has been provided.');
        }
    }
    /*
       * Returns whether or not keepalive integration is enabled.
       * @return True if integration is enabled; otherwise, false.
       */
    /**
     * @return {?}
     */
    getKeepaliveEnabled() {
        return this.keepaliveEnabled;
    }
    /*
       * Sets and returns whether or not keepalive integration is enabled.
       * @param True if the integration is enabled; otherwise, false.
       * @return The current value.
       */
    /**
     * @param {?} value
     * @return {?}
     */
    setKeepaliveEnabled(value) {
        if (!this.keepaliveSvc) {
            throw new Error('Cannot enable keepalive integration because no KeepaliveSvc has been provided.');
        }
        return (this.keepaliveEnabled = value);
    }
    /*
       * Returns the current timeout value.
       * @return The timeout value in seconds.
       */
    /**
     * @return {?}
     */
    getTimeout() {
        return this.timeoutVal;
    }
    /*
       * Sets the timeout value.
       * @param seconds - The timeout value in seconds. 0 or false to disable timeout feature.
       * @return The current value. If disabled, the value will be 0.
       */
    /**
     * @param {?} seconds
     * @return {?}
     */
    setTimeout(seconds) {
        if (seconds === false) {
            this.timeoutVal = 0;
        }
        else if (typeof seconds === 'number' && seconds >= 0) {
            this.timeoutVal = seconds;
        }
        else {
            throw new Error("'seconds' can only be 'false' or a positive number.");
        }
        return this.timeoutVal;
    }
    /*
       * Returns the current idle value.
       * @return The idle value in seconds.
       */
    /**
     * @return {?}
     */
    getIdle() {
        return this.idle;
    }
    /*
       * Sets the idle value.
       * @param seconds - The idle value in seconds.
       * @return The idle value in seconds.
       */
    /**
     * @param {?} seconds
     * @return {?}
     */
    setIdle(seconds) {
        if (seconds <= 0) {
            throw new Error("'seconds' must be greater zero");
        }
        return (this.idle = seconds);
    }
    /*
       * Returns the current autoresume value.
       * @return The current value.
       */
    /**
     * @return {?}
     */
    getAutoResume() {
        return this.autoResume;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    setAutoResume(value) {
        return (this.autoResume = value);
    }
    /*
       * Sets interrupts from the specified sources.
       * @param sources - Interrupt sources.
       * @return The resulting interrupts.
       */
    /**
     * @param {?} sources
     * @return {?}
     */
    setInterrupts(sources) {
        this.clearInterrupts();
        /** @type {?} */
        const self = this;
        for (const source of sources) {
            /** @type {?} */
            const sub = new Interrupt(source);
            sub.subscribe((/**
             * @param {?} args
             * @return {?}
             */
            (args) => {
                self.interrupt(args.force, args.innerArgs);
            }));
            this.interrupts.push(sub);
        }
        return this.interrupts;
    }
    /*
       * Returns the current interrupts.
       * @return The current interrupts.
       */
    /**
     * @return {?}
     */
    getInterrupts() {
        return this.interrupts;
    }
    /*
       * Pauses, unsubscribes, and clears the current interrupt subscriptions.
       */
    /**
     * @return {?}
     */
    clearInterrupts() {
        for (const sub of this.interrupts) {
            sub.pause();
            sub.unsubscribe();
        }
        this.interrupts.length = 0;
    }
    /*
       * Returns whether or not the service is running i.e. watching for idleness.
       * @return True if service is watching; otherwise, false.
       */
    /**
     * @return {?}
     */
    isRunning() {
        return this.running;
    }
    /*
       * Returns whether or not the user is considered idle.
       * @return True if the user is in the idle state; otherwise, false.
       */
    /**
     * @return {?}
     */
    isIdling() {
        return this.idling;
    }
    /*
       * Starts watching for inactivity.
       */
    /**
     * @param {?=} skipExpiry
     * @return {?}
     */
    watch(skipExpiry) {
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        /** @type {?} */
        const timeout = !this.timeoutVal ? 0 : this.timeoutVal;
        if (!skipExpiry) {
            /** @type {?} */
            const value = new Date(this.expiry.now().getTime() + (this.idle + timeout) * 1000);
            this.expiry.last(value);
        }
        if (this.idling) {
            this.toggleState();
        }
        if (!this.running) {
            this.startKeepalive();
            this.toggleInterrupts(true);
        }
        this.running = true;
        /** @type {?} */
        const watchFn = (/**
         * @return {?}
         */
        () => {
            this.zone.run((/**
             * @return {?}
             */
            () => {
                /** @type {?} */
                const diff = this.getExpiryDiff(timeout);
                if (diff > 0) {
                    this.safeClearInterval('idleHandle');
                    this.setIdleIntervalOutsideOfZone(watchFn, diff);
                }
                else {
                    this.toggleState();
                }
            }));
        });
        this.setIdleIntervalOutsideOfZone(watchFn, this.idle * 1000);
    }
    /*
       * Allows protractor tests to call waitForAngular without hanging
       */
    /**
     * @param {?} watchFn
     * @param {?} frequency
     * @return {?}
     */
    setIdleIntervalOutsideOfZone(watchFn, frequency) {
        this.zone.runOutsideAngular((/**
         * @return {?}
         */
        () => {
            this.idleHandle = setInterval(watchFn, frequency);
        }));
    }
    /*
       * Stops watching for inactivity.
       */
    /**
     * @return {?}
     */
    stop() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(false);
        this.running = false;
        this.expiry.last(null);
    }
    /*
       * Forces a timeout event and state.
       */
    /**
     * @return {?}
     */
    timeout() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(true);
        this.running = false;
        this.countdown = 0;
        this.onTimeout.emit(null);
    }
    /*
       * Signals that user activity has occurred.
       * @param force - Forces watch to be called, unless they are timed out.
       * @param eventArgs - Optional source event arguments.
       */
    /**
     * @param {?=} force
     * @param {?=} eventArgs
     * @return {?}
     */
    interrupt(force, eventArgs) {
        if (!this.running) {
            return;
        }
        if (this.timeoutVal && this.expiry.isExpired()) {
            this.timeout();
            return;
        }
        this.onInterrupt.emit(eventArgs);
        if (force === true ||
            this.autoResume === AutoResume.idle ||
            (this.autoResume === AutoResume.notIdle && !this.expiry.idling())) {
            this.watch(force);
        }
    }
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    setIdling(value) {
        this.idling = value;
        this.expiry.idling(value);
    }
    /**
     * @private
     * @return {?}
     */
    toggleState() {
        this.setIdling(!this.idling);
        if (this.idling) {
            this.onIdleStart.emit(null);
            this.stopKeepalive();
            if (this.timeoutVal > 0) {
                this.countdown = this.timeoutVal;
                this.doCountdown();
                this.setTimoutIntervalOutsideZone((/**
                 * @return {?}
                 */
                () => {
                    this.doCountdownInZone();
                }), 1000);
            }
        }
        else {
            this.toggleInterrupts(true);
            this.onIdleEnd.emit(null);
            this.startKeepalive();
        }
        this.safeClearInterval('idleHandle');
    }
    /**
     * @private
     * @param {?} intervalFn
     * @param {?} frequency
     * @return {?}
     */
    setTimoutIntervalOutsideZone(intervalFn, frequency) {
        this.zone.runOutsideAngular((/**
         * @return {?}
         */
        () => {
            this.timeoutHandle = setInterval((/**
             * @return {?}
             */
            () => {
                intervalFn();
            }), frequency);
        }));
    }
    /**
     * @private
     * @param {?} resume
     * @return {?}
     */
    toggleInterrupts(resume) {
        for (const interrupt of this.interrupts) {
            if (resume) {
                interrupt.resume();
            }
            else {
                interrupt.pause();
            }
        }
    }
    /**
     * @private
     * @param {?} timeout
     * @return {?}
     */
    getExpiryDiff(timeout) {
        /** @type {?} */
        const now = this.expiry.now();
        /** @type {?} */
        const last = this.expiry.last() || now;
        return last.getTime() - now.getTime() - timeout * 1000;
    }
    /**
     * @private
     * @return {?}
     */
    doCountdownInZone() {
        this.zone.run((/**
         * @return {?}
         */
        () => {
            this.doCountdown();
        }));
    }
    /**
     * @private
     * @return {?}
     */
    doCountdown() {
        /** @type {?} */
        const diff = this.getExpiryDiff(this.timeoutVal);
        if (diff > 0) {
            this.safeClearInterval('timeoutHandle');
            this.interrupt(true);
            return;
        }
        if (!this.idling) {
            return;
        }
        if (this.countdown <= 0) {
            this.timeout();
            return;
        }
        this.onTimeoutWarning.emit(this.countdown);
        this.countdown--;
    }
    /**
     * @private
     * @param {?} handleName
     * @return {?}
     */
    safeClearInterval(handleName) {
        /** @type {?} */
        const handle = this[handleName];
        if (handle !== null && typeof handle !== 'undefined') {
            clearInterval(this[handleName]);
            this[handleName] = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    startKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        if (this.running) {
            this.keepaliveSvc.ping();
        }
        this.keepaliveSvc.start();
    }
    /**
     * @private
     * @return {?}
     */
    stopKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        this.keepaliveSvc.stop();
    }
    /*
       * Called by Angular when destroying the instance.
       */
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.stop();
        this.clearInterrupts();
    }
}
Idle.decorators = [
    { type: Injectable }
];
/** @nocollapse */
Idle.ctorParameters = () => [
    { type: IdleExpiry },
    { type: NgZone },
    { type: KeepaliveSvc, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.idle;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.timeoutVal;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.autoResume;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.interrupts;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.running;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.idling;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.idleHandle;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.timeoutHandle;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.countdown;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.keepaliveEnabled;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.keepaliveSvc;
    /** @type {?} */
    Idle.prototype.onIdleStart;
    /** @type {?} */
    Idle.prototype.onIdleEnd;
    /** @type {?} */
    Idle.prototype.onTimeoutWarning;
    /** @type {?} */
    Idle.prototype.onTimeout;
    /** @type {?} */
    Idle.prototype.onInterrupt;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.expiry;
    /**
     * @type {?}
     * @private
     */
    Idle.prototype.zone;
    /* Skipping unhandled member: [key: string]: any;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZy1pZGxlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvaWRsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNMLFlBQVksRUFDWixVQUFVLEVBQ1YsTUFBTSxFQUVOLFFBQVEsRUFDVCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHeEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7SUFNeEQ7O09BRUc7SUFDSCxXQUFRO0lBQ1I7O09BRUc7SUFDSCxPQUFJO0lBQ0o7O09BRUc7SUFDSCxVQUFPOzs7Ozs7Ozs7QUFPVCxNQUFNLE9BQU8sSUFBSTs7Ozs7O0lBcUJmLFlBQ1UsTUFBa0IsRUFDbEIsSUFBWSxFQUNSLFlBQTJCO1FBRi9CLFdBQU0sR0FBTixNQUFNLENBQVk7UUFDbEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQXRCZCxTQUFJLEdBQVcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLGFBQWE7O1FBQ3JDLGVBQVUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhOztRQUM5QixlQUFVLEdBQWUsVUFBVSxDQUFDLElBQUksQ0FBQztRQUN6QyxlQUFVLEdBQXFCLElBQUksS0FBSyxFQUFFLENBQUM7UUFDM0MsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUtoQixxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFHMUIsZ0JBQVcsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNwRCxjQUFTLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDbEQscUJBQWdCLEdBQXlCLElBQUksWUFBWSxFQUFVLENBQUM7UUFDcEUsY0FBUyxHQUF5QixJQUFJLFlBQVks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O0lBQ3hCLDBCQUFpRDs7Ozs7SUFDakQsMEJBQW1EOzs7OztJQUNuRCx1QkFBd0I7Ozs7O0lBQ3hCLHNCQUF3Qjs7Ozs7SUFDeEIsMEJBQXdCOzs7OztJQUN4Qiw2QkFBMkI7Ozs7O0lBQzNCLHlCQUEwQjs7Ozs7SUFDMUIsZ0NBQWlDOzs7OztJQUNqQyw0QkFBbUM7O0lBRW5DLDJCQUEyRDs7SUFDM0QseUJBQXlEOztJQUN6RCxnQ0FBMkU7O0lBQzNFLHlCQUFvRTs7SUFDcEUsMkJBQTJEOzs7OztJQUt6RCxzQkFBMEI7Ozs7O0lBQzFCLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEV2ZW50RW1pdHRlcixcbiAgSW5qZWN0YWJsZSxcbiAgTmdab25lLFxuICBPbkRlc3Ryb3ksXG4gIE9wdGlvbmFsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBJZGxlRXhwaXJ5IH0gZnJvbSAnLi9pZGxlZXhwaXJ5JztcbmltcG9ydCB7IEludGVycnVwdCB9IGZyb20gJy4vaW50ZXJydXB0JztcbmltcG9ydCB7IEludGVycnVwdEFyZ3MgfSBmcm9tICcuL2ludGVycnVwdGFyZ3MnO1xuaW1wb3J0IHsgSW50ZXJydXB0U291cmNlIH0gZnJvbSAnLi9pbnRlcnJ1cHRzb3VyY2UnO1xuaW1wb3J0IHsgS2VlcGFsaXZlU3ZjIH0gZnJvbSAnLi9rZWVwYWxpdmVzdmMnO1xuaW1wb3J0IHsgTG9jYWxTdG9yYWdlRXhwaXJ5IH0gZnJvbSAnLi9sb2NhbHN0b3JhZ2VleHBpcnknO1xuXG4vKlxuICogSW5kaWNhdGVzIHRoZSBkZXNpcmVkIGF1dG8gcmVzdW1lIGJlaGF2aW9yLlxuICovXG5leHBvcnQgZW51bSBBdXRvUmVzdW1lIHtcbiAgLypcbiAgICogQXV0byByZXN1bWUgZnVuY3Rpb25hbGl0eSB3aWxsIGJlIGRpc2FibGVkLlxuICAgKi9cbiAgZGlzYWJsZWQsXG4gIC8qXG4gICAqIENhbiByZXN1bWUgYXV0b21hdGljYWxseSBldmVuIGlmIHRoZXkgYXJlIGlkbGUuXG4gICAqL1xuICBpZGxlLFxuICAvKlxuICAgKiBDYW4gb25seSByZXN1bWUgYXV0b21hdGljYWxseSBpZiB0aGV5IGFyZSBub3QgeWV0IGlkbGUuXG4gICAqL1xuICBub3RJZGxlXG59XG5cbi8qKlxuICogQSBzZXJ2aWNlIGZvciBkZXRlY3RpbmcgYW5kIHJlc3BvbmRpbmcgdG8gdXNlciBpZGxlbmVzcy5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIElkbGUgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGlkbGU6IG51bWJlciA9IDIwICogNjA7IC8vIGluIHNlY29uZHNcbiAgcHJpdmF0ZSB0aW1lb3V0VmFsID0gMzA7IC8vIGluIHNlY29uZHNcbiAgcHJpdmF0ZSBhdXRvUmVzdW1lOiBBdXRvUmVzdW1lID0gQXV0b1Jlc3VtZS5pZGxlO1xuICBwcml2YXRlIGludGVycnVwdHM6IEFycmF5PEludGVycnVwdD4gPSBuZXcgQXJyYXkoKTtcbiAgcHJpdmF0ZSBydW5uaW5nID0gZmFsc2U7XG4gIHByaXZhdGUgaWRsaW5nOiBib29sZWFuO1xuICBwcml2YXRlIGlkbGVIYW5kbGU6IGFueTtcbiAgcHJpdmF0ZSB0aW1lb3V0SGFuZGxlOiBhbnk7XG4gIHByaXZhdGUgY291bnRkb3duOiBudW1iZXI7XG4gIHByaXZhdGUga2VlcGFsaXZlRW5hYmxlZCA9IGZhbHNlO1xuICBwcml2YXRlIGtlZXBhbGl2ZVN2YzogS2VlcGFsaXZlU3ZjO1xuXG4gIHB1YmxpYyBvbklkbGVTdGFydDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIHB1YmxpYyBvbklkbGVFbmQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwdWJsaWMgb25UaW1lb3V0V2FybmluZzogRXZlbnRFbWl0dGVyPG51bWJlcj4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcbiAgcHVibGljIG9uVGltZW91dDogRXZlbnRFbWl0dGVyPG51bWJlcj4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcbiAgcHVibGljIG9uSW50ZXJydXB0OiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBba2V5OiBzdHJpbmddOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBleHBpcnk6IElkbGVFeHBpcnksXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXG4gICAgQE9wdGlvbmFsKCkga2VlcGFsaXZlU3ZjPzogS2VlcGFsaXZlU3ZjXG4gICkge1xuICAgIGlmIChrZWVwYWxpdmVTdmMpIHtcbiAgICAgIHRoaXMua2VlcGFsaXZlU3ZjID0ga2VlcGFsaXZlU3ZjO1xuICAgICAgdGhpcy5rZWVwYWxpdmVFbmFibGVkID0gdHJ1ZTtcbiAgICB9XG4gICAgdGhpcy5zZXRJZGxpbmcoZmFsc2UpO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyB0aGUgaWRsZSBuYW1lIGZvciBsb2NhbFN0b3JhZ2UuXG4gICAqIEltcG9ydGFudCB0byBzZXQgaWYgbXVsdGlwbGUgaW5zdGFuY2VzIG9mIElkbGUgd2l0aCBMb2NhbFN0b3JhZ2VFeHBpcnlcbiAgICogQHBhcmFtIFRoZSBuYW1lIG9mIHRoZSBpZGxlLlxuICAgKi9cbiAgc2V0SWRsZU5hbWUoa2V5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5leHBpcnkgaW5zdGFuY2VvZiBMb2NhbFN0b3JhZ2VFeHBpcnkpIHtcbiAgICAgIHRoaXMuZXhwaXJ5LnNldElkbGVOYW1lKGtleSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0Nhbm5vdCBzZXQgZXhwaXJ5IGtleSBuYW1lIGJlY2F1c2Ugbm8gTG9jYWxTdG9yYWdlRXhwaXJ5IGhhcyBiZWVuIHByb3ZpZGVkLidcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB3aGV0aGVyIG9yIG5vdCBrZWVwYWxpdmUgaW50ZWdyYXRpb24gaXMgZW5hYmxlZC5cbiAgICogQHJldHVybiBUcnVlIGlmIGludGVncmF0aW9uIGlzIGVuYWJsZWQ7IG90aGVyd2lzZSwgZmFsc2UuXG4gICAqL1xuICBnZXRLZWVwYWxpdmVFbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmtlZXBhbGl2ZUVuYWJsZWQ7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIGFuZCByZXR1cm5zIHdoZXRoZXIgb3Igbm90IGtlZXBhbGl2ZSBpbnRlZ3JhdGlvbiBpcyBlbmFibGVkLlxuICAgKiBAcGFyYW0gVHJ1ZSBpZiB0aGUgaW50ZWdyYXRpb24gaXMgZW5hYmxlZDsgb3RoZXJ3aXNlLCBmYWxzZS5cbiAgICogQHJldHVybiBUaGUgY3VycmVudCB2YWx1ZS5cbiAgICovXG4gIHNldEtlZXBhbGl2ZUVuYWJsZWQodmFsdWU6IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICBpZiAoIXRoaXMua2VlcGFsaXZlU3ZjKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdDYW5ub3QgZW5hYmxlIGtlZXBhbGl2ZSBpbnRlZ3JhdGlvbiBiZWNhdXNlIG5vIEtlZXBhbGl2ZVN2YyBoYXMgYmVlbiBwcm92aWRlZC4nXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiAodGhpcy5rZWVwYWxpdmVFbmFibGVkID0gdmFsdWUpO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCB0aW1lb3V0IHZhbHVlLlxuICAgKiBAcmV0dXJuIFRoZSB0aW1lb3V0IHZhbHVlIGluIHNlY29uZHMuXG4gICAqL1xuICBnZXRUaW1lb3V0KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMudGltZW91dFZhbDtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgdGhlIHRpbWVvdXQgdmFsdWUuXG4gICAqIEBwYXJhbSBzZWNvbmRzIC0gVGhlIHRpbWVvdXQgdmFsdWUgaW4gc2Vjb25kcy4gMCBvciBmYWxzZSB0byBkaXNhYmxlIHRpbWVvdXQgZmVhdHVyZS5cbiAgICogQHJldHVybiBUaGUgY3VycmVudCB2YWx1ZS4gSWYgZGlzYWJsZWQsIHRoZSB2YWx1ZSB3aWxsIGJlIDAuXG4gICAqL1xuICBzZXRUaW1lb3V0KHNlY29uZHM6IG51bWJlciB8IGJvb2xlYW4pOiBudW1iZXIge1xuICAgIGlmIChzZWNvbmRzID09PSBmYWxzZSkge1xuICAgICAgdGhpcy50aW1lb3V0VmFsID0gMDtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBzZWNvbmRzID09PSAnbnVtYmVyJyAmJiBzZWNvbmRzID49IDApIHtcbiAgICAgIHRoaXMudGltZW91dFZhbCA9IHNlY29uZHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIidzZWNvbmRzJyBjYW4gb25seSBiZSAnZmFsc2UnIG9yIGEgcG9zaXRpdmUgbnVtYmVyLlwiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy50aW1lb3V0VmFsO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCBpZGxlIHZhbHVlLlxuICAgKiBAcmV0dXJuIFRoZSBpZGxlIHZhbHVlIGluIHNlY29uZHMuXG4gICAqL1xuICBnZXRJZGxlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuaWRsZTtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgdGhlIGlkbGUgdmFsdWUuXG4gICAqIEBwYXJhbSBzZWNvbmRzIC0gVGhlIGlkbGUgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICogQHJldHVybiBUaGUgaWRsZSB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKi9cbiAgc2V0SWRsZShzZWNvbmRzOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGlmIChzZWNvbmRzIDw9IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIidzZWNvbmRzJyBtdXN0IGJlIGdyZWF0ZXIgemVyb1wiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gKHRoaXMuaWRsZSA9IHNlY29uZHMpO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCBhdXRvcmVzdW1lIHZhbHVlLlxuICAgKiBAcmV0dXJuIFRoZSBjdXJyZW50IHZhbHVlLlxuICAgKi9cbiAgZ2V0QXV0b1Jlc3VtZSgpOiBBdXRvUmVzdW1lIHtcbiAgICByZXR1cm4gdGhpcy5hdXRvUmVzdW1lO1xuICB9XG5cbiAgc2V0QXV0b1Jlc3VtZSh2YWx1ZTogQXV0b1Jlc3VtZSk6IEF1dG9SZXN1bWUge1xuICAgIHJldHVybiAodGhpcy5hdXRvUmVzdW1lID0gdmFsdWUpO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyBpbnRlcnJ1cHRzIGZyb20gdGhlIHNwZWNpZmllZCBzb3VyY2VzLlxuICAgKiBAcGFyYW0gc291cmNlcyAtIEludGVycnVwdCBzb3VyY2VzLlxuICAgKiBAcmV0dXJuIFRoZSByZXN1bHRpbmcgaW50ZXJydXB0cy5cbiAgICovXG4gIHNldEludGVycnVwdHMoc291cmNlczogQXJyYXk8SW50ZXJydXB0U291cmNlPik6IEFycmF5PEludGVycnVwdD4ge1xuICAgIHRoaXMuY2xlYXJJbnRlcnJ1cHRzKCk7XG5cbiAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgIGZvciAoY29uc3Qgc291cmNlIG9mIHNvdXJjZXMpIHtcbiAgICAgIGNvbnN0IHN1YiA9IG5ldyBJbnRlcnJ1cHQoc291cmNlKTtcbiAgICAgIHN1Yi5zdWJzY3JpYmUoKGFyZ3M6IEludGVycnVwdEFyZ3MpID0+IHtcbiAgICAgICAgc2VsZi5pbnRlcnJ1cHQoYXJncy5mb3JjZSwgYXJncy5pbm5lckFyZ3MpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuaW50ZXJydXB0cy5wdXNoKHN1Yik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuaW50ZXJydXB0cztcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgaW50ZXJydXB0cy5cbiAgICogQHJldHVybiBUaGUgY3VycmVudCBpbnRlcnJ1cHRzLlxuICAgKi9cbiAgZ2V0SW50ZXJydXB0cygpOiBBcnJheTxJbnRlcnJ1cHQ+IHtcbiAgICByZXR1cm4gdGhpcy5pbnRlcnJ1cHRzO1xuICB9XG5cbiAgLypcbiAgICogUGF1c2VzLCB1bnN1YnNjcmliZXMsIGFuZCBjbGVhcnMgdGhlIGN1cnJlbnQgaW50ZXJydXB0IHN1YnNjcmlwdGlvbnMuXG4gICAqL1xuICBjbGVhckludGVycnVwdHMoKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBzdWIgb2YgdGhpcy5pbnRlcnJ1cHRzKSB7XG4gICAgICBzdWIucGF1c2UoKTtcbiAgICAgIHN1Yi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIHRoaXMuaW50ZXJydXB0cy5sZW5ndGggPSAwO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB3aGV0aGVyIG9yIG5vdCB0aGUgc2VydmljZSBpcyBydW5uaW5nIGkuZS4gd2F0Y2hpbmcgZm9yIGlkbGVuZXNzLlxuICAgKiBAcmV0dXJuIFRydWUgaWYgc2VydmljZSBpcyB3YXRjaGluZzsgb3RoZXJ3aXNlLCBmYWxzZS5cbiAgICovXG4gIGlzUnVubmluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5ydW5uaW5nO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB3aGV0aGVyIG9yIG5vdCB0aGUgdXNlciBpcyBjb25zaWRlcmVkIGlkbGUuXG4gICAqIEByZXR1cm4gVHJ1ZSBpZiB0aGUgdXNlciBpcyBpbiB0aGUgaWRsZSBzdGF0ZTsgb3RoZXJ3aXNlLCBmYWxzZS5cbiAgICovXG4gIGlzSWRsaW5nKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlkbGluZztcbiAgfVxuXG4gIC8qXG4gICAqIFN0YXJ0cyB3YXRjaGluZyBmb3IgaW5hY3Rpdml0eS5cbiAgICovXG4gIHdhdGNoKHNraXBFeHBpcnk/OiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ3RpbWVvdXRIYW5kbGUnKTtcblxuICAgIGNvbnN0IHRpbWVvdXQgPSAhdGhpcy50aW1lb3V0VmFsID8gMCA6IHRoaXMudGltZW91dFZhbDtcbiAgICBpZiAoIXNraXBFeHBpcnkpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gbmV3IERhdGUoXG4gICAgICAgIHRoaXMuZXhwaXJ5Lm5vdygpLmdldFRpbWUoKSArICh0aGlzLmlkbGUgKyB0aW1lb3V0KSAqIDEwMDBcbiAgICAgICk7XG4gICAgICB0aGlzLmV4cGlyeS5sYXN0KHZhbHVlKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pZGxpbmcpIHtcbiAgICAgIHRoaXMudG9nZ2xlU3RhdGUoKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnJ1bm5pbmcpIHtcbiAgICAgIHRoaXMuc3RhcnRLZWVwYWxpdmUoKTtcbiAgICAgIHRoaXMudG9nZ2xlSW50ZXJydXB0cyh0cnVlKTtcbiAgICB9XG5cbiAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlO1xuXG4gICAgY29uc3Qgd2F0Y2hGbiA9ICgpID0+IHtcbiAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICBjb25zdCBkaWZmID0gdGhpcy5nZXRFeHBpcnlEaWZmKHRpbWVvdXQpO1xuICAgICAgICBpZiAoZGlmZiA+IDApIHtcbiAgICAgICAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCdpZGxlSGFuZGxlJyk7XG4gICAgICAgICAgdGhpcy5zZXRJZGxlSW50ZXJ2YWxPdXRzaWRlT2Zab25lKHdhdGNoRm4sIGRpZmYpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudG9nZ2xlU3RhdGUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfTtcblxuICAgIHRoaXMuc2V0SWRsZUludGVydmFsT3V0c2lkZU9mWm9uZSh3YXRjaEZuLCB0aGlzLmlkbGUgKiAxMDAwKTtcbiAgfVxuXG4gIC8qXG4gICAqIEFsbG93cyBwcm90cmFjdG9yIHRlc3RzIHRvIGNhbGwgd2FpdEZvckFuZ3VsYXIgd2l0aG91dCBoYW5naW5nXG4gICAqL1xuICBzZXRJZGxlSW50ZXJ2YWxPdXRzaWRlT2Zab25lKHdhdGNoRm46ICgpID0+IHZvaWQsIGZyZXF1ZW5jeTogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMuaWRsZUhhbmRsZSA9IHNldEludGVydmFsKHdhdGNoRm4sIGZyZXF1ZW5jeSk7XG4gICAgfSk7XG4gIH1cblxuICAvKlxuICAgKiBTdG9wcyB3YXRjaGluZyBmb3IgaW5hY3Rpdml0eS5cbiAgICovXG4gIHN0b3AoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wS2VlcGFsaXZlKCk7XG5cbiAgICB0aGlzLnRvZ2dsZUludGVycnVwdHMoZmFsc2UpO1xuXG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ3RpbWVvdXRIYW5kbGUnKTtcblxuICAgIHRoaXMuc2V0SWRsaW5nKGZhbHNlKTtcbiAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcblxuICAgIHRoaXMuZXhwaXJ5Lmxhc3QobnVsbCk7XG4gIH1cblxuICAvKlxuICAgKiBGb3JjZXMgYSB0aW1lb3V0IGV2ZW50IGFuZCBzdGF0ZS5cbiAgICovXG4gIHRpbWVvdXQoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wS2VlcGFsaXZlKCk7XG5cbiAgICB0aGlzLnRvZ2dsZUludGVycnVwdHMoZmFsc2UpO1xuXG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ3RpbWVvdXRIYW5kbGUnKTtcblxuICAgIHRoaXMuc2V0SWRsaW5nKHRydWUpO1xuICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICAgIHRoaXMuY291bnRkb3duID0gMDtcblxuICAgIHRoaXMub25UaW1lb3V0LmVtaXQobnVsbCk7XG4gIH1cblxuICAvKlxuICAgKiBTaWduYWxzIHRoYXQgdXNlciBhY3Rpdml0eSBoYXMgb2NjdXJyZWQuXG4gICAqIEBwYXJhbSBmb3JjZSAtIEZvcmNlcyB3YXRjaCB0byBiZSBjYWxsZWQsIHVubGVzcyB0aGV5IGFyZSB0aW1lZCBvdXQuXG4gICAqIEBwYXJhbSBldmVudEFyZ3MgLSBPcHRpb25hbCBzb3VyY2UgZXZlbnQgYXJndW1lbnRzLlxuICAgKi9cbiAgaW50ZXJydXB0KGZvcmNlPzogYm9vbGVhbiwgZXZlbnRBcmdzPzogYW55KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnJ1bm5pbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50aW1lb3V0VmFsICYmIHRoaXMuZXhwaXJ5LmlzRXhwaXJlZCgpKSB7XG4gICAgICB0aGlzLnRpbWVvdXQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5vbkludGVycnVwdC5lbWl0KGV2ZW50QXJncyk7XG5cbiAgICBpZiAoXG4gICAgICBmb3JjZSA9PT0gdHJ1ZSB8fFxuICAgICAgdGhpcy5hdXRvUmVzdW1lID09PSBBdXRvUmVzdW1lLmlkbGUgfHxcbiAgICAgICh0aGlzLmF1dG9SZXN1bWUgPT09IEF1dG9SZXN1bWUubm90SWRsZSAmJiAhdGhpcy5leHBpcnkuaWRsaW5nKCkpXG4gICAgKSB7XG4gICAgICB0aGlzLndhdGNoKGZvcmNlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldElkbGluZyh2YWx1ZTogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuaWRsaW5nID0gdmFsdWU7XG4gICAgdGhpcy5leHBpcnkuaWRsaW5nKHZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgdG9nZ2xlU3RhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5zZXRJZGxpbmcoIXRoaXMuaWRsaW5nKTtcblxuICAgIGlmICh0aGlzLmlkbGluZykge1xuICAgICAgdGhpcy5vbklkbGVTdGFydC5lbWl0KG51bGwpO1xuICAgICAgdGhpcy5zdG9wS2VlcGFsaXZlKCk7XG5cbiAgICAgIGlmICh0aGlzLnRpbWVvdXRWYWwgPiAwKSB7XG4gICAgICAgIHRoaXMuY291bnRkb3duID0gdGhpcy50aW1lb3V0VmFsO1xuICAgICAgICB0aGlzLmRvQ291bnRkb3duKCk7XG4gICAgICAgIHRoaXMuc2V0VGltb3V0SW50ZXJ2YWxPdXRzaWRlWm9uZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5kb0NvdW50ZG93bkluWm9uZSgpO1xuICAgICAgICB9LCAxMDAwKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50b2dnbGVJbnRlcnJ1cHRzKHRydWUpO1xuICAgICAgdGhpcy5vbklkbGVFbmQuZW1pdChudWxsKTtcbiAgICAgIHRoaXMuc3RhcnRLZWVwYWxpdmUoKTtcbiAgICB9XG5cbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCdpZGxlSGFuZGxlJyk7XG4gIH1cblxuICBwcml2YXRlIHNldFRpbW91dEludGVydmFsT3V0c2lkZVpvbmUoXG4gICAgaW50ZXJ2YWxGbjogKCkgPT4gdm9pZCxcbiAgICBmcmVxdWVuY3k6IG51bWJlclxuICApIHtcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy50aW1lb3V0SGFuZGxlID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICBpbnRlcnZhbEZuKCk7XG4gICAgICB9LCBmcmVxdWVuY3kpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVJbnRlcnJ1cHRzKHJlc3VtZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGZvciAoY29uc3QgaW50ZXJydXB0IG9mIHRoaXMuaW50ZXJydXB0cykge1xuICAgICAgaWYgKHJlc3VtZSkge1xuICAgICAgICBpbnRlcnJ1cHQucmVzdW1lKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbnRlcnJ1cHQucGF1c2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEV4cGlyeURpZmYodGltZW91dDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBjb25zdCBub3c6IERhdGUgPSB0aGlzLmV4cGlyeS5ub3coKTtcbiAgICBjb25zdCBsYXN0OiBEYXRlID0gdGhpcy5leHBpcnkubGFzdCgpIHx8IG5vdztcbiAgICByZXR1cm4gbGFzdC5nZXRUaW1lKCkgLSBub3cuZ2V0VGltZSgpIC0gdGltZW91dCAqIDEwMDA7XG4gIH1cblxuICBwcml2YXRlIGRvQ291bnRkb3duSW5ab25lKCk6IHZvaWQge1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgdGhpcy5kb0NvdW50ZG93bigpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NvdW50ZG93bigpOiB2b2lkIHtcbiAgICBjb25zdCBkaWZmID0gdGhpcy5nZXRFeHBpcnlEaWZmKHRoaXMudGltZW91dFZhbCk7XG4gICAgaWYgKGRpZmYgPiAwKSB7XG4gICAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG4gICAgICB0aGlzLmludGVycnVwdCh0cnVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaWRsaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY291bnRkb3duIDw9IDApIHtcbiAgICAgIHRoaXMudGltZW91dCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMub25UaW1lb3V0V2FybmluZy5lbWl0KHRoaXMuY291bnRkb3duKTtcbiAgICB0aGlzLmNvdW50ZG93bi0tO1xuICB9XG5cbiAgcHJpdmF0ZSBzYWZlQ2xlYXJJbnRlcnZhbChoYW5kbGVOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBoYW5kbGUgPSB0aGlzW2hhbmRsZU5hbWVdO1xuICAgIGlmIChoYW5kbGUgIT09IG51bGwgJiYgdHlwZW9mIGhhbmRsZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpc1toYW5kbGVOYW1lXSk7XG4gICAgICB0aGlzW2hhbmRsZU5hbWVdID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0S2VlcGFsaXZlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5rZWVwYWxpdmVTdmMgfHwgIXRoaXMua2VlcGFsaXZlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgIHRoaXMua2VlcGFsaXZlU3ZjLnBpbmcoKTtcbiAgICB9XG5cbiAgICB0aGlzLmtlZXBhbGl2ZVN2Yy5zdGFydCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdG9wS2VlcGFsaXZlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5rZWVwYWxpdmVTdmMgfHwgIXRoaXMua2VlcGFsaXZlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMua2VlcGFsaXZlU3ZjLnN0b3AoKTtcbiAgfVxuXG4gIC8qXG4gICAqIENhbGxlZCBieSBBbmd1bGFyIHdoZW4gZGVzdHJveWluZyB0aGUgaW5zdGFuY2UuXG4gICAqL1xuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3AoKTtcbiAgICB0aGlzLmNsZWFySW50ZXJydXB0cygpO1xuICB9XG59XG4iXX0=