/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
/**
 * @record
 */
export function EmailOptions() { }
if (false) {
    /** @type {?} */
    EmailOptions.prototype.domains;
    /** @type {?} */
    EmailOptions.prototype.secondLevelDomains;
    /** @type {?} */
    EmailOptions.prototype.topLevelDomains;
}
/**
 * @record
 */
export function SplittedEmail() { }
if (false) {
    /** @type {?} */
    SplittedEmail.prototype.topLevelDomain;
    /** @type {?} */
    SplittedEmail.prototype.secondLevelDomain;
    /** @type {?} */
    SplittedEmail.prototype.domain;
    /** @type {?} */
    SplittedEmail.prototype.address;
}
/**
 * @record
 */
export function Suggestion() { }
if (false) {
    /** @type {?} */
    Suggestion.prototype.address;
    /** @type {?} */
    Suggestion.prototype.domain;
    /** @type {?} */
    Suggestion.prototype.full;
}
/**
 * @record
 */
function Offset() { }
if (false) {
    /** @type {?} */
    Offset.prototype.c1;
    /** @type {?} */
    Offset.prototype.c2;
    /** @type {?} */
    Offset.prototype.trans;
}
var EmailSuggestion = /** @class */ (function () {
    function EmailSuggestion() {
        this.defaultOptions = {
            domains: ['msn.com', 'bellsouth.net',
                'telus.net', 'comcast.net', 'optusnet.com.au',
                'earthlink.net', 'qq.com', 'sky.com', 'icloud.com',
                'mac.com', 'sympatico.ca', 'googlemail.com',
                'att.net', 'xtra.co.nz', 'web.de',
                'cox.net', 'gmail.com', 'ymail.com', 'yahoo.com',
                'aim.com', 'rogers.com', 'verizon.net',
                'rocketmail.com', 'google.com', 'optonline.net',
                'sbcglobal.net', 'aol.com', 'me.com', 'btinternet.com',
                'charter.net', 'shaw.ca'],
            secondLevelDomains: ["yahoo", "hotmail", "mail", "live", "outlook", "gmx"],
            topLevelDomains: ["com", "com.au", "com.tw", "ca", "co.nz", "co.uk", "de",
                "fr", "it", "ru", "net", "org", "edu", "gov", "jp", "nl", "kr", "se", "eu",
                "ie", "co.il", "us", "at", "be", "dk", "hk", "es", "gr", "ch", "no", "cz",
                "in", "net", "net.au", "info", "biz", "mil", "co.jp", "sg", "hu", "uk"]
        };
    }
    /**
     * @param {?} email
     * @param {?=} options
     * @return {?}
     */
    EmailSuggestion.prototype.suggest = /**
     * @param {?} email
     * @param {?=} options
     * @return {?}
     */
    function (email, options) {
        /** @type {?} */
        var opt = this.defaultOptions;
        if (options != undefined) {
            opt = options;
        }
        /** @type {?} */
        var emailParts = this.splitEmail(email.toLowerCase());
        if (!emailParts) {
            return undefined;
        }
        if (opt.secondLevelDomains && opt.topLevelDomains) {
            // If the email is a valid 2nd-level + top-level, do not suggest anything.
            if (opt.secondLevelDomains.indexOf(emailParts.secondLevelDomain) !== -1 && opt.topLevelDomains.indexOf(emailParts.topLevelDomain) !== -1) {
                return undefined;
            }
        }
        /** @type {?} */
        var closestDomain = this.findClosestDomain(emailParts.domain, opt.domains, 2);
        if (closestDomain) {
            if (closestDomain == emailParts.domain) {
                // The email address exactly matches one of the supplied domains; do not return a suggestion.
                return undefined;
            }
            else {
                // The email address closely matches one of the supplied domains; return a suggestion
                return { suggestion: { address: emailParts.address, domain: closestDomain, full: emailParts.address + "@" + closestDomain } };
            }
        }
        /** @type {?} */
        var closestSecondLevelDomain = this.findClosestDomain(emailParts.secondLevelDomain, opt.secondLevelDomains, 2);
        /** @type {?} */
        var closestTopLevelDomain = this.findClosestDomain(emailParts.topLevelDomain, opt.topLevelDomains, 2);
        if (emailParts.domain) {
            closestDomain = emailParts.domain;
            /** @type {?} */
            var rtrn = false;
            if (closestSecondLevelDomain && closestSecondLevelDomain != emailParts.secondLevelDomain) {
                // The email address may have a mispelled second-level domain; return a suggestion
                closestDomain = closestDomain.replace(emailParts.secondLevelDomain, closestSecondLevelDomain);
                rtrn = true;
            }
            if (closestTopLevelDomain && closestTopLevelDomain != emailParts.topLevelDomain && emailParts.secondLevelDomain !== '') {
                // The email address may have a mispelled top-level domain; return a suggestion
                closestDomain = closestDomain.replace(new RegExp(emailParts.topLevelDomain + "$"), closestTopLevelDomain);
                rtrn = true;
            }
            if (rtrn) {
                return { suggestion: { address: emailParts.address, domain: closestDomain, full: emailParts.address + "@" + closestDomain } };
            }
        }
        /* The email address exactly matches one of the supplied domains, does not closely
         * match any domain and does not appear to simply have a mispelled top-level domain,
         * or is an invalid email address; do not return a suggestion.
         */
        return undefined;
    };
    ;
    /**
     * @param {?} email
     * @return {?}
     */
    EmailSuggestion.prototype.splitEmail = /**
     * @param {?} email
     * @return {?}
     */
    function (email) {
        /** @type {?} */
        var parts = email.trim().split('@');
        if (parts.length < 2) {
            return undefined;
        }
        for (var i = 0; i < parts.length; i++) {
            if (parts[i] === '') {
                return undefined;
            }
        }
        /** @type {?} */
        var result = {
            topLevelDomain: "",
            secondLevelDomain: "",
            domain: parts.pop(),
            address: ''
        };
        /** @type {?} */
        var domainParts = result.domain.split('.');
        if (domainParts.length === 0) {
            return undefined;
        }
        else if (domainParts.length == 1) {
            result.topLevelDomain = domainParts[0];
        }
        else {
            // The address has a domain and a top-level domain
            result.secondLevelDomain = domainParts[0];
            for (var j = 1; j < domainParts.length; j++) {
                result.topLevelDomain += domainParts[j] + '.';
            }
            result.topLevelDomain = result.topLevelDomain.substring(0, result.topLevelDomain.length - 1);
        }
        result.address = parts.join('@');
        return result;
    };
    /**
     * @param {?} domain
     * @param {?} domains
     * @param {?} threshold
     * @return {?}
     */
    EmailSuggestion.prototype.findClosestDomain = /**
     * @param {?} domain
     * @param {?} domains
     * @param {?} threshold
     * @return {?}
     */
    function (domain, domains, threshold) {
        /** @type {?} */
        var dist;
        /** @type {?} */
        var minDist = Infinity;
        /** @type {?} */
        var closestDomain = null;
        if (!domain || !domains) {
            return undefined;
        }
        for (var i = 0; i < domains.length; i++) {
            if (domain === domains[i]) {
                return domain;
            }
            dist = this.sift4Distance(domain, domains[i], 5);
            if (dist < minDist) {
                minDist = dist;
                closestDomain = domains[i];
            }
        }
        if (minDist <= threshold && closestDomain !== null) {
            return closestDomain;
        }
        else {
            return undefined;
        }
    };
    /**
     * @param {?} s1
     * @param {?} s2
     * @param {?} maxOffset
     * @return {?}
     */
    EmailSuggestion.prototype.sift4Distance = /**
     * @param {?} s1
     * @param {?} s2
     * @param {?} maxOffset
     * @return {?}
     */
    function (s1, s2, maxOffset) {
        // sift4: https://siderite.blogspot.com/2014/11/super-fast-and-accurate-string-distance.html
        if (maxOffset === undefined) {
            maxOffset = 5; //default
        }
        if (!s1 || !s1.length) {
            if (!s2) {
                return 0;
            }
            return s2.length;
        }
        if (!s2 || !s2.length) {
            return s1.length;
        }
        /** @type {?} */
        var l1 = s1.length;
        /** @type {?} */
        var l2 = s2.length;
        /** @type {?} */
        var c1 = 0;
        //cursor for string 1
        /** @type {?} */
        var c2 = 0;
        //cursor for string 2
        /** @type {?} */
        var lcss = 0;
        //largest common subsequence
        /** @type {?} */
        var local_cs = 0;
        //local common substring
        /** @type {?} */
        var trans = 0;
        //number of transpositions ('ab' vs 'ba')
        /** @type {?} */
        var offset_arr = [];
        while ((c1 < l1) && (c2 < l2)) {
            if (s1.charAt(c1) == s2.charAt(c2)) {
                local_cs++;
                /** @type {?} */
                var isTrans = false;
                //see if current match is a transposition
                /** @type {?} */
                var i = 0;
                while (i < offset_arr.length) {
                    /** @type {?} */
                    var ofs = offset_arr[i];
                    if (c1 <= ofs.c1 || c2 <= ofs.c2) {
                        // when two matches cross, the one considered a transposition is the one with the largest difference in offsets
                        isTrans = Math.abs(c2 - c1) >= Math.abs(ofs.c2 - ofs.c1);
                        if (isTrans) {
                            trans++;
                        }
                        else {
                            if (!ofs.trans) {
                                ofs.trans = true;
                                trans++;
                            }
                        }
                        break;
                    }
                    else {
                        if (c1 > ofs.c2 && c2 > ofs.c1) {
                            offset_arr.splice(i, 1);
                        }
                        else {
                            i++;
                        }
                    }
                }
                offset_arr.push({
                    c1: c1,
                    c2: c2,
                    trans: isTrans
                });
            }
            else {
                lcss += local_cs;
                local_cs = 0;
                if (c1 != c2) {
                    c1 = c2 = Math.min(c1, c2); //using min allows the computation of transpositions
                }
                //if matching characters are found, remove 1 from both cursors (they get incremented at the end of the loop)
                //so that we can have only one code block handling matches 
                for (var j = 0; j < maxOffset && (c1 + j < l1 || c2 + j < l2); j++) {
                    if ((c1 + j < l1) && (s1.charAt(c1 + j) == s2.charAt(c2))) {
                        c1 += j - 1;
                        c2--;
                        break;
                    }
                    if ((c2 + j < l2) && (s1.charAt(c1) == s2.charAt(c2 + j))) {
                        c1--;
                        c2 += j - 1;
                        break;
                    }
                }
            }
            c1++;
            c2++;
            // this covers the case where the last match is on the last token in list, so that it can compute transpositions correctly
            if ((c1 >= l1) || (c2 >= l2)) {
                lcss += local_cs;
                local_cs = 0;
                c1 = c2 = Math.min(c1, c2);
            }
        }
        lcss += local_cs;
        return Math.round(Math.max(l1, l2) - lcss + trans); //add the cost of transpositions to the final result
    };
    return EmailSuggestion;
}());
export { EmailSuggestion };
if (false) {
    /** @type {?} */
    EmailSuggestion.prototype.defaultOptions;
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1haWwtdXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC12YWxpZGF0b3JzLyIsInNvdXJjZXMiOlsiY29tcG9uZW50cy9lbWFpbC9lbWFpbC11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFZQSxrQ0FJQzs7O0lBSEcsK0JBQWtCOztJQUNsQiwwQ0FBNkI7O0lBQzdCLHVDQUF5Qjs7Ozs7QUFHN0IsbUNBS0M7OztJQUpHLHVDQUF1Qjs7SUFDdkIsMENBQTBCOztJQUMxQiwrQkFBZTs7SUFDZixnQ0FBZTs7Ozs7QUFHbkIsZ0NBSUM7OztJQUhHLDZCQUFnQjs7SUFDaEIsNEJBQWU7O0lBQ2YsMEJBQVk7Ozs7O0FBR2hCLHFCQUlDOzs7SUFIRyxvQkFBVzs7SUFDWCxvQkFBVzs7SUFDWCx1QkFBYzs7QUFHbEI7SUFBQTtRQUVZLG1CQUFjLEdBQWlCO1lBQ25DLE9BQU8sRUFBRSxDQUFDLFNBQVMsRUFBRSxlQUFlO2dCQUNoQyxXQUFXLEVBQUUsYUFBYSxFQUFFLGlCQUFpQjtnQkFDN0MsZUFBZSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWTtnQkFDbEQsU0FBUyxFQUFFLGNBQWMsRUFBRSxnQkFBZ0I7Z0JBQzNDLFNBQVMsRUFBRSxZQUFZLEVBQUUsUUFBUTtnQkFDakMsU0FBUyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsV0FBVztnQkFDaEQsU0FBUyxFQUFFLFlBQVksRUFBRSxhQUFhO2dCQUN0QyxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsZUFBZTtnQkFDL0MsZUFBZSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsZ0JBQWdCO2dCQUN0RCxhQUFhLEVBQUUsU0FBUyxDQUFDO1lBQzdCLGtCQUFrQixFQUFFLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUM7WUFDMUUsZUFBZSxFQUFFLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFB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QUFFLEVBQUUsQ0FBQztZQUNMLDBIQUEwSDtZQUMxSCxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFO2dCQUMxQixJQUFJLElBQUksUUFBUSxDQUFDO2dCQUNqQixRQUFRLEdBQUcsQ0FBQyxDQUFDO2dCQUNiLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDOUI7U0FDSjtRQUNELElBQUksSUFBSSxRQUFRLENBQUM7UUFDakIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLG9EQUFvRDtJQUM1RyxDQUFDO0lBQ0wsc0JBQUM7QUFBRCxDQUFDLEFBblBELElBbVBDOzs7O0lBalBHLHlDQWdCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuXG4vKlxuICogQ29kZSBmcm9tTWFpbGNoZWNrIGh0dHBzOi8vZ2l0aHViLmNvbS9tYWlsY2hlY2svbWFpbGNoZWNrXG4gKiBBdXRob3JcbiAqIERlcnJpY2sgS28gKEBkZXJyaWNra28pXG4gKlxuICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxuICpcbiAqIHYgMS4xLjJcbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIEVtYWlsT3B0aW9ucyB7XG4gICAgZG9tYWluczogc3RyaW5nW10sXG4gICAgc2Vjb25kTGV2ZWxEb21haW5zOiBzdHJpbmdbXSxcbiAgICB0b3BMZXZlbERvbWFpbnM6IHN0cmluZ1tdXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3BsaXR0ZWRFbWFpbCB7XG4gICAgdG9wTGV2ZWxEb21haW46IHN0cmluZyxcbiAgICBzZWNvbmRMZXZlbERvbWFpbjogc3RyaW5nLFxuICAgIGRvbWFpbjogc3RyaW5nLFxuICAgIGFkZHJlc3M6IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN1Z2dlc3Rpb24ge1xuICAgIGFkZHJlc3M6IHN0cmluZyxcbiAgICBkb21haW46IHN0cmluZyxcbiAgICBmdWxsOiBzdHJpbmdcbn1cblxuaW50ZXJmYWNlIE9mZnNldCB7XG4gICAgYzE6IG51bWJlcixcbiAgICBjMjogbnVtYmVyLFxuICAgIHRyYW5zOiBib29sZWFuXG59XG5cbmV4cG9ydCBjbGFzcyBFbWFpbFN1Z2dlc3Rpb24ge1xuXG4gICAgcHJpdmF0ZSBkZWZhdWx0T3B0aW9uczogRW1haWxPcHRpb25zID0ge1xuICAgICAgICBkb21haW5zOiBbJ21zbi5jb20nLCAnYmVsbHNvdXRoLm5ldCcsXG4gICAgICAgICAgICAndGVsdXMubmV0JywgJ2NvbWNhc3QubmV0JywgJ29wdHVzbmV0LmNvbS5hdScsXG4gICAgICAgICAgICAnZWFydGhsaW5rLm5ldCcsICdxcS5jb20nLCAnc2t5LmNvbScsICdpY2xvdWQuY29tJyxcbiAgICAgICAgICAgICdtYWMuY29tJywgJ3N5bXBhdGljby5jYScsICdnb29nbGVtYWlsLmNvbScsXG4gICAgICAgICAgICAnYXR0Lm5ldCcsICd4dHJhLmNvLm56JywgJ3dlYi5kZScsXG4gICAgICAgICAgICAnY294Lm5ldCcsICdnbWFpbC5jb20nLCAneW1haWwuY29tJywgJ3lhaG9vLmNvbScsXG4gICAgICAgICAgICAnYWltLmNvbScsICdyb2dlcnMuY29tJywgJ3Zlcml6b24ubmV0JyxcbiAgICAgICAgICAgICdyb2NrZXRtYWlsLmNvbScsICdnb29nbGUuY29tJywgJ29wdG9ubGluZS5uZXQnLFxuICAgICAgICAgICAgJ3NiY2dsb2JhbC5uZXQnLCAnYW9sLmNvbScsICdtZS5jb20nLCAnYnRpbnRlcm5ldC5jb20nLFxuICAgICAgICAgICAgJ2NoYXJ0ZXIubmV0JywgJ3NoYXcuY2EnXSxcbiAgICAgICAgc2Vjb25kTGV2ZWxEb21haW5zOiBbXCJ5YWhvb1wiLCBcImhvdG1haWxcIiwgXCJtYWlsXCIsIFwibGl2ZVwiLCBcIm91dGxvb2tcIiwgXCJnbXhcIl0sXG4gICAgICAgIHRvcExldmVsRG9tYWluczogW1wiY29tXCIsIFwiY29tLmF1XCIsIFwiY29tLnR3XCIsIFwiY2FcIiwgXCJjby5uelwiLCBcImNvLnVrXCIsIFwiZGVcIixcbiAgICAgICAgICAgIFwiZnJcIiwgXCJpdFwiLCBcInJ1XCIsIFwibmV0XCIsIFwib3JnXCIsIFwiZWR1XCIsIFwiZ292XCIsIFwianBcIiwgXCJubFwiLCBcImtyXCIsIFwic2VcIiwgXCJldVwiLFxuICAgICAgICAgICAgXCJpZVwiLCBcImNvLmlsXCIsIFwidXNcIiwgXCJhdFwiLCBcImJlXCIsIFwiZGtcIiwgXCJoa1wiLCBcImVzXCIsIFwiZ3JcIiwgXCJjaFwiLCBcIm5vXCIsIFwiY3pcIixcbiAgICAgICAgICAgIFwiaW5cIiwgXCJuZXRcIiwgXCJuZXQuYXVcIiwgXCJpbmZvXCIsIFwiYml6XCIsIFwibWlsXCIsIFwiY28uanBcIiwgXCJzZ1wiLCBcImh1XCIsIFwidWtcIl1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3VnZ2VzdChlbWFpbDogc3RyaW5nLCBvcHRpb25zPzogRW1haWxPcHRpb25zKTogeyBba2V5OiBzdHJpbmddOiBTdWdnZXN0aW9uIH0ge1xuICAgICAgICBsZXQgb3B0ID0gdGhpcy5kZWZhdWx0T3B0aW9ucztcbiAgICAgICAgaWYgKG9wdGlvbnMgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBvcHQgPSBvcHRpb25zO1xuICAgICAgICB9XG4gICAgICAgIGxldCBlbWFpbFBhcnRzID0gdGhpcy5zcGxpdEVtYWlsKGVtYWlsLnRvTG93ZXJDYXNlKCkpO1xuXG4gICAgICAgIGlmICghZW1haWxQYXJ0cykge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHQuc2Vjb25kTGV2ZWxEb21haW5zICYmIG9wdC50b3BMZXZlbERvbWFpbnMpIHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBlbWFpbCBpcyBhIHZhbGlkIDJuZC1sZXZlbCArIHRvcC1sZXZlbCwgZG8gbm90IHN1Z2dlc3QgYW55dGhpbmcuXG4gICAgICAgICAgICBpZiAob3B0LnNlY29uZExldmVsRG9tYWlucy5pbmRleE9mKGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4pICE9PSAtMSAmJiBvcHQudG9wTGV2ZWxEb21haW5zLmluZGV4T2YoZW1haWxQYXJ0cy50b3BMZXZlbERvbWFpbikgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjbG9zZXN0RG9tYWluID0gdGhpcy5maW5kQ2xvc2VzdERvbWFpbihlbWFpbFBhcnRzLmRvbWFpbiwgb3B0LmRvbWFpbnMsIDIpO1xuICAgICAgICBpZiAoY2xvc2VzdERvbWFpbikge1xuICAgICAgICAgICAgaWYgKGNsb3Nlc3REb21haW4gPT0gZW1haWxQYXJ0cy5kb21haW4pIHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgZW1haWwgYWRkcmVzcyBleGFjdGx5IG1hdGNoZXMgb25lIG9mIHRoZSBzdXBwbGllZCBkb21haW5zOyBkbyBub3QgcmV0dXJuIGEgc3VnZ2VzdGlvbi5cbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgZW1haWwgYWRkcmVzcyBjbG9zZWx5IG1hdGNoZXMgb25lIG9mIHRoZSBzdXBwbGllZCBkb21haW5zOyByZXR1cm4gYSBzdWdnZXN0aW9uXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VnZ2VzdGlvbjogeyBhZGRyZXNzOiBlbWFpbFBhcnRzLmFkZHJlc3MsIGRvbWFpbjogY2xvc2VzdERvbWFpbiwgZnVsbDogZW1haWxQYXJ0cy5hZGRyZXNzICsgXCJAXCIgKyBjbG9zZXN0RG9tYWluIH0gfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4gPSB0aGlzLmZpbmRDbG9zZXN0RG9tYWluKGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4sIG9wdC5zZWNvbmRMZXZlbERvbWFpbnMsIDIpO1xuICAgICAgICBsZXQgY2xvc2VzdFRvcExldmVsRG9tYWluID0gdGhpcy5maW5kQ2xvc2VzdERvbWFpbihlbWFpbFBhcnRzLnRvcExldmVsRG9tYWluLCBvcHQudG9wTGV2ZWxEb21haW5zLCAyKTtcblxuICAgICAgICBpZiAoZW1haWxQYXJ0cy5kb21haW4pIHtcbiAgICAgICAgICAgIGNsb3Nlc3REb21haW4gPSBlbWFpbFBhcnRzLmRvbWFpbjtcbiAgICAgICAgICAgIGxldCBydHJuID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmIChjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4gJiYgY2xvc2VzdFNlY29uZExldmVsRG9tYWluICE9IGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4pIHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgZW1haWwgYWRkcmVzcyBtYXkgaGF2ZSBhIG1pc3BlbGxlZCBzZWNvbmQtbGV2ZWwgZG9tYWluOyByZXR1cm4gYSBzdWdnZXN0aW9uXG4gICAgICAgICAgICAgICAgY2xvc2VzdERvbWFpbiA9IGNsb3Nlc3REb21haW4ucmVwbGFjZShlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluLCBjbG9zZXN0U2Vjb25kTGV2ZWxEb21haW4pO1xuICAgICAgICAgICAgICAgIHJ0cm4gPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2xvc2VzdFRvcExldmVsRG9tYWluICYmIGNsb3Nlc3RUb3BMZXZlbERvbWFpbiAhPSBlbWFpbFBhcnRzLnRvcExldmVsRG9tYWluICYmIGVtYWlsUGFydHMuc2Vjb25kTGV2ZWxEb21haW4gIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIGVtYWlsIGFkZHJlc3MgbWF5IGhhdmUgYSBtaXNwZWxsZWQgdG9wLWxldmVsIGRvbWFpbjsgcmV0dXJuIGEgc3VnZ2VzdGlvblxuICAgICAgICAgICAgICAgIGNsb3Nlc3REb21haW4gPSBjbG9zZXN0RG9tYWluLnJlcGxhY2UobmV3IFJlZ0V4cChlbWFpbFBhcnRzLnRvcExldmVsRG9tYWluICsgXCIkXCIpLCBjbG9zZXN0VG9wTGV2ZWxEb21haW4pO1xuICAgICAgICAgICAgICAgIHJ0cm4gPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocnRybikge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Z2dlc3Rpb246IHsgYWRkcmVzczogZW1haWxQYXJ0cy5hZGRyZXNzLCBkb21haW46IGNsb3Nlc3REb21haW4sIGZ1bGw6IGVtYWlsUGFydHMuYWRkcmVzcyArIFwiQFwiICsgY2xvc2VzdERvbWFpbiB9IH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvKiBUaGUgZW1haWwgYWRkcmVzcyBleGFjdGx5IG1hdGNoZXMgb25lIG9mIHRoZSBzdXBwbGllZCBkb21haW5zLCBkb2VzIG5vdCBjbG9zZWx5XG4gICAgICAgICAqIG1hdGNoIGFueSBkb21haW4gYW5kIGRvZXMgbm90IGFwcGVhciB0byBzaW1wbHkgaGF2ZSBhIG1pc3BlbGxlZCB0b3AtbGV2ZWwgZG9tYWluLFxuICAgICAgICAgKiBvciBpcyBhbiBpbnZhbGlkIGVtYWlsIGFkZHJlc3M7IGRvIG5vdCByZXR1cm4gYSBzdWdnZXN0aW9uLlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgIH07XG5cbiAgICBwdWJsaWMgc3BsaXRFbWFpbChlbWFpbDogc3RyaW5nKSB7XG5cbiAgICAgICAgbGV0IHBhcnRzID0gZW1haWwudHJpbSgpLnNwbGl0KCdAJyk7XG5cbiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAocGFydHNbaV0gPT09ICcnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZXN1bHQgPSB7XG4gICAgICAgICAgICB0b3BMZXZlbERvbWFpbjogXCJcIixcbiAgICAgICAgICAgIHNlY29uZExldmVsRG9tYWluOiBcIlwiLFxuICAgICAgICAgICAgZG9tYWluOiBwYXJ0cy5wb3AoKSxcbiAgICAgICAgICAgIGFkZHJlc3M6ICcnXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZG9tYWluUGFydHMgPSByZXN1bHQuZG9tYWluLnNwbGl0KCcuJyk7XG5cbiAgICAgICAgaWYgKGRvbWFpblBhcnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfSBlbHNlIGlmIChkb21haW5QYXJ0cy5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgcmVzdWx0LnRvcExldmVsRG9tYWluID0gZG9tYWluUGFydHNbMF07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBUaGUgYWRkcmVzcyBoYXMgYSBkb21haW4gYW5kIGEgdG9wLWxldmVsIGRvbWFpblxuICAgICAgICAgICAgcmVzdWx0LnNlY29uZExldmVsRG9tYWluID0gZG9tYWluUGFydHNbMF07XG4gICAgICAgICAgICBmb3IgKGxldCBqID0gMTsgaiA8IGRvbWFpblBhcnRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnRvcExldmVsRG9tYWluICs9IGRvbWFpblBhcnRzW2pdICsgJy4nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnRvcExldmVsRG9tYWluID0gcmVzdWx0LnRvcExldmVsRG9tYWluLnN1YnN0cmluZygwLCByZXN1bHQudG9wTGV2ZWxEb21haW4ubGVuZ3RoIC0gMSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXN1bHQuYWRkcmVzcyA9IHBhcnRzLmpvaW4oJ0AnKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaW5kQ2xvc2VzdERvbWFpbihkb21haW46IHN0cmluZywgZG9tYWluczogc3RyaW5nW10sIHRocmVzaG9sZDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGRpc3Q7XG4gICAgICAgIGxldCBtaW5EaXN0ID0gSW5maW5pdHk7XG4gICAgICAgIGxldCBjbG9zZXN0RG9tYWluID0gbnVsbDtcblxuICAgICAgICBpZiAoIWRvbWFpbiB8fCAhZG9tYWlucykge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZG9tYWlucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYgKGRvbWFpbiA9PT0gZG9tYWluc1tpXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkb21haW47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkaXN0ID0gdGhpcy5zaWZ0NERpc3RhbmNlKGRvbWFpbiwgZG9tYWluc1tpXSwgNSk7XG4gICAgICAgICAgICBpZiAoZGlzdCA8IG1pbkRpc3QpIHtcbiAgICAgICAgICAgICAgICBtaW5EaXN0ID0gZGlzdDtcbiAgICAgICAgICAgICAgICBjbG9zZXN0RG9tYWluID0gZG9tYWluc1tpXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtaW5EaXN0IDw9IHRocmVzaG9sZCAmJiBjbG9zZXN0RG9tYWluICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gY2xvc2VzdERvbWFpbjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNpZnQ0RGlzdGFuY2UoczE6IHN0cmluZywgczI6IHN0cmluZywgbWF4T2Zmc2V0OiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICAvLyBzaWZ0NDogaHR0cHM6Ly9zaWRlcml0ZS5ibG9nc3BvdC5jb20vMjAxNC8xMS9zdXBlci1mYXN0LWFuZC1hY2N1cmF0ZS1zdHJpbmctZGlzdGFuY2UuaHRtbFxuICAgICAgICBpZiAobWF4T2Zmc2V0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIG1heE9mZnNldCA9IDU7IC8vZGVmYXVsdFxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFzMSB8fCAhczEubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoIXMyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gczIubGVuZ3RoO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFzMiB8fCAhczIubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gczEubGVuZ3RoO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGwxID0gczEubGVuZ3RoO1xuICAgICAgICBsZXQgbDIgPSBzMi5sZW5ndGg7XG5cbiAgICAgICAgbGV0IGMxID0gMDsgIC8vY3Vyc29yIGZvciBzdHJpbmcgMVxuICAgICAgICBsZXQgYzIgPSAwOyAgLy9jdXJzb3IgZm9yIHN0cmluZyAyXG4gICAgICAgIGxldCBsY3NzID0gMDsgIC8vbGFyZ2VzdCBjb21tb24gc3Vic2VxdWVuY2VcbiAgICAgICAgbGV0IGxvY2FsX2NzID0gMDsgLy9sb2NhbCBjb21tb24gc3Vic3RyaW5nXG4gICAgICAgIGxldCB0cmFucyA9IDA7ICAvL251bWJlciBvZiB0cmFuc3Bvc2l0aW9ucyAoJ2FiJyB2cyAnYmEnKVxuICAgICAgICBsZXQgb2Zmc2V0X2FycjogT2Zmc2V0W10gPSBbXTsgIC8vb2Zmc2V0IHBhaXIgYXJyYXksIGZvciBjb21wdXRpbmcgdGhlIHRyYW5zcG9zaXRpb25zXG5cbiAgICAgICAgd2hpbGUgKChjMSA8IGwxKSAmJiAoYzIgPCBsMikpIHtcbiAgICAgICAgICAgIGlmIChzMS5jaGFyQXQoYzEpID09IHMyLmNoYXJBdChjMikpIHtcbiAgICAgICAgICAgICAgICBsb2NhbF9jcysrO1xuICAgICAgICAgICAgICAgIGxldCBpc1RyYW5zID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgLy9zZWUgaWYgY3VycmVudCBtYXRjaCBpcyBhIHRyYW5zcG9zaXRpb25cbiAgICAgICAgICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgICAgICAgICAgd2hpbGUgKGkgPCBvZmZzZXRfYXJyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgb2ZzID0gb2Zmc2V0X2FycltpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGMxIDw9IG9mcy5jMSB8fCBjMiA8PSBvZnMuYzIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gdHdvIG1hdGNoZXMgY3Jvc3MsIHRoZSBvbmUgY29uc2lkZXJlZCBhIHRyYW5zcG9zaXRpb24gaXMgdGhlIG9uZSB3aXRoIHRoZSBsYXJnZXN0IGRpZmZlcmVuY2UgaW4gb2Zmc2V0c1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUcmFucyA9IE1hdGguYWJzKGMyIC0gYzEpID49IE1hdGguYWJzKG9mcy5jMiAtIG9mcy5jMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNUcmFucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zKys7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb2ZzLnRyYW5zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mcy50cmFucyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYzEgPiBvZnMuYzIgJiYgYzIgPiBvZnMuYzEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRfYXJyLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9mZnNldF9hcnIucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIGMxOiBjMSxcbiAgICAgICAgICAgICAgICAgICAgYzI6IGMyLFxuICAgICAgICAgICAgICAgICAgICB0cmFuczogaXNUcmFuc1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsY3NzICs9IGxvY2FsX2NzO1xuICAgICAgICAgICAgICAgIGxvY2FsX2NzID0gMDtcbiAgICAgICAgICAgICAgICBpZiAoYzEgIT0gYzIpIHtcbiAgICAgICAgICAgICAgICAgICAgYzEgPSBjMiA9IE1hdGgubWluKGMxLCBjMik7ICAvL3VzaW5nIG1pbiBhbGxvd3MgdGhlIGNvbXB1dGF0aW9uIG9mIHRyYW5zcG9zaXRpb25zXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vaWYgbWF0Y2hpbmcgY2hhcmFjdGVycyBhcmUgZm91bmQsIHJlbW92ZSAxIGZyb20gYm90aCBjdXJzb3JzICh0aGV5IGdldCBpbmNyZW1lbnRlZCBhdCB0aGUgZW5kIG9mIHRoZSBsb29wKVxuICAgICAgICAgICAgICAgIC8vc28gdGhhdCB3ZSBjYW4gaGF2ZSBvbmx5IG9uZSBjb2RlIGJsb2NrIGhhbmRsaW5nIG1hdGNoZXMgXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBtYXhPZmZzZXQgJiYgKGMxICsgaiA8IGwxIHx8IGMyICsgaiA8IGwyKTsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgoYzEgKyBqIDwgbDEpICYmIChzMS5jaGFyQXQoYzEgKyBqKSA9PSBzMi5jaGFyQXQoYzIpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYzEgKz0gaiAtIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICBjMi0tO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKChjMiArIGogPCBsMikgJiYgKHMxLmNoYXJBdChjMSkgPT0gczIuY2hhckF0KGMyICsgaikpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjMS0tO1xuICAgICAgICAgICAgICAgICAgICAgICAgYzIgKz0gaiAtIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGMxKys7XG4gICAgICAgICAgICBjMisrO1xuICAgICAgICAgICAgLy8gdGhpcyBjb3ZlcnMgdGhlIGNhc2Ugd2hlcmUgdGhlIGxhc3QgbWF0Y2ggaXMgb24gdGhlIGxhc3QgdG9rZW4gaW4gbGlzdCwgc28gdGhhdCBpdCBjYW4gY29tcHV0ZSB0cmFuc3Bvc2l0aW9ucyBjb3JyZWN0bHlcbiAgICAgICAgICAgIGlmICgoYzEgPj0gbDEpIHx8IChjMiA+PSBsMikpIHtcbiAgICAgICAgICAgICAgICBsY3NzICs9IGxvY2FsX2NzO1xuICAgICAgICAgICAgICAgIGxvY2FsX2NzID0gMDtcbiAgICAgICAgICAgICAgICBjMSA9IGMyID0gTWF0aC5taW4oYzEsIGMyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsY3NzICs9IGxvY2FsX2NzO1xuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChNYXRoLm1heChsMSwgbDIpIC0gbGNzcyArIHRyYW5zKTsgLy9hZGQgdGhlIGNvc3Qgb2YgdHJhbnNwb3NpdGlvbnMgdG8gdGhlIGZpbmFsIHJlc3VsdFxuICAgIH1cbn0iXX0=