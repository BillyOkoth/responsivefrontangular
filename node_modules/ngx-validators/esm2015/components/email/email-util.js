/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
/**
 * @record
 */
export function EmailOptions() { }
if (false) {
    /** @type {?} */
    EmailOptions.prototype.domains;
    /** @type {?} */
    EmailOptions.prototype.secondLevelDomains;
    /** @type {?} */
    EmailOptions.prototype.topLevelDomains;
}
/**
 * @record
 */
export function SplittedEmail() { }
if (false) {
    /** @type {?} */
    SplittedEmail.prototype.topLevelDomain;
    /** @type {?} */
    SplittedEmail.prototype.secondLevelDomain;
    /** @type {?} */
    SplittedEmail.prototype.domain;
    /** @type {?} */
    SplittedEmail.prototype.address;
}
/**
 * @record
 */
export function Suggestion() { }
if (false) {
    /** @type {?} */
    Suggestion.prototype.address;
    /** @type {?} */
    Suggestion.prototype.domain;
    /** @type {?} */
    Suggestion.prototype.full;
}
/**
 * @record
 */
function Offset() { }
if (false) {
    /** @type {?} */
    Offset.prototype.c1;
    /** @type {?} */
    Offset.prototype.c2;
    /** @type {?} */
    Offset.prototype.trans;
}
export class EmailSuggestion {
    constructor() {
        this.defaultOptions = {
            domains: ['msn.com', 'bellsouth.net',
                'telus.net', 'comcast.net', 'optusnet.com.au',
                'earthlink.net', 'qq.com', 'sky.com', 'icloud.com',
                'mac.com', 'sympatico.ca', 'googlemail.com',
                'att.net', 'xtra.co.nz', 'web.de',
                'cox.net', 'gmail.com', 'ymail.com', 'yahoo.com',
                'aim.com', 'rogers.com', 'verizon.net',
                'rocketmail.com', 'google.com', 'optonline.net',
                'sbcglobal.net', 'aol.com', 'me.com', 'btinternet.com',
                'charter.net', 'shaw.ca'],
            secondLevelDomains: ["yahoo", "hotmail", "mail", "live", "outlook", "gmx"],
            topLevelDomains: ["com", "com.au", "com.tw", "ca", "co.nz", "co.uk", "de",
                "fr", "it", "ru", "net", "org", "edu", "gov", "jp", "nl", "kr", "se", "eu",
                "ie", "co.il", "us", "at", "be", "dk", "hk", "es", "gr", "ch", "no", "cz",
                "in", "net", "net.au", "info", "biz", "mil", "co.jp", "sg", "hu", "uk"]
        };
    }
    /**
     * @param {?} email
     * @param {?=} options
     * @return {?}
     */
    suggest(email, options) {
        /** @type {?} */
        let opt = this.defaultOptions;
        if (options != undefined) {
            opt = options;
        }
        /** @type {?} */
        let emailParts = this.splitEmail(email.toLowerCase());
        if (!emailParts) {
            return undefined;
        }
        if (opt.secondLevelDomains && opt.topLevelDomains) {
            // If the email is a valid 2nd-level + top-level, do not suggest anything.
            if (opt.secondLevelDomains.indexOf(emailParts.secondLevelDomain) !== -1 && opt.topLevelDomains.indexOf(emailParts.topLevelDomain) !== -1) {
                return undefined;
            }
        }
        /** @type {?} */
        let closestDomain = this.findClosestDomain(emailParts.domain, opt.domains, 2);
        if (closestDomain) {
            if (closestDomain == emailParts.domain) {
                // The email address exactly matches one of the supplied domains; do not return a suggestion.
                return undefined;
            }
            else {
                // The email address closely matches one of the supplied domains; return a suggestion
                return { suggestion: { address: emailParts.address, domain: closestDomain, full: emailParts.address + "@" + closestDomain } };
            }
        }
        /** @type {?} */
        let closestSecondLevelDomain = this.findClosestDomain(emailParts.secondLevelDomain, opt.secondLevelDomains, 2);
        /** @type {?} */
        let closestTopLevelDomain = this.findClosestDomain(emailParts.topLevelDomain, opt.topLevelDomains, 2);
        if (emailParts.domain) {
            closestDomain = emailParts.domain;
            /** @type {?} */
            let rtrn = false;
            if (closestSecondLevelDomain && closestSecondLevelDomain != emailParts.secondLevelDomain) {
                // The email address may have a mispelled second-level domain; return a suggestion
                closestDomain = closestDomain.replace(emailParts.secondLevelDomain, closestSecondLevelDomain);
                rtrn = true;
            }
            if (closestTopLevelDomain && closestTopLevelDomain != emailParts.topLevelDomain && emailParts.secondLevelDomain !== '') {
                // The email address may have a mispelled top-level domain; return a suggestion
                closestDomain = closestDomain.replace(new RegExp(emailParts.topLevelDomain + "$"), closestTopLevelDomain);
                rtrn = true;
            }
            if (rtrn) {
                return { suggestion: { address: emailParts.address, domain: closestDomain, full: emailParts.address + "@" + closestDomain } };
            }
        }
        /* The email address exactly matches one of the supplied domains, does not closely
         * match any domain and does not appear to simply have a mispelled top-level domain,
         * or is an invalid email address; do not return a suggestion.
         */
        return undefined;
    }
    ;
    /**
     * @param {?} email
     * @return {?}
     */
    splitEmail(email) {
        /** @type {?} */
        let parts = email.trim().split('@');
        if (parts.length < 2) {
            return undefined;
        }
        for (var i = 0; i < parts.length; i++) {
            if (parts[i] === '') {
                return undefined;
            }
        }
        /** @type {?} */
        let result = {
            topLevelDomain: "",
            secondLevelDomain: "",
            domain: parts.pop(),
            address: ''
        };
        /** @type {?} */
        let domainParts = result.domain.split('.');
        if (domainParts.length === 0) {
            return undefined;
        }
        else if (domainParts.length == 1) {
            result.topLevelDomain = domainParts[0];
        }
        else {
            // The address has a domain and a top-level domain
            result.secondLevelDomain = domainParts[0];
            for (let j = 1; j < domainParts.length; j++) {
                result.topLevelDomain += domainParts[j] + '.';
            }
            result.topLevelDomain = result.topLevelDomain.substring(0, result.topLevelDomain.length - 1);
        }
        result.address = parts.join('@');
        return result;
    }
    /**
     * @param {?} domain
     * @param {?} domains
     * @param {?} threshold
     * @return {?}
     */
    findClosestDomain(domain, domains, threshold) {
        /** @type {?} */
        let dist;
        /** @type {?} */
        let minDist = Infinity;
        /** @type {?} */
        let closestDomain = null;
        if (!domain || !domains) {
            return undefined;
        }
        for (let i = 0; i < domains.length; i++) {
            if (domain === domains[i]) {
                return domain;
            }
            dist = this.sift4Distance(domain, domains[i], 5);
            if (dist < minDist) {
                minDist = dist;
                closestDomain = domains[i];
            }
        }
        if (minDist <= threshold && closestDomain !== null) {
            return closestDomain;
        }
        else {
            return undefined;
        }
    }
    /**
     * @param {?} s1
     * @param {?} s2
     * @param {?} maxOffset
     * @return {?}
     */
    sift4Distance(s1, s2, maxOffset) {
        // sift4: https://siderite.blogspot.com/2014/11/super-fast-and-accurate-string-distance.html
        if (maxOffset === undefined) {
            maxOffset = 5; //default
        }
        if (!s1 || !s1.length) {
            if (!s2) {
                return 0;
            }
            return s2.length;
        }
        if (!s2 || !s2.length) {
            return s1.length;
        }
        /** @type {?} */
        let l1 = s1.length;
        /** @type {?} */
        let l2 = s2.length;
        /** @type {?} */
        let c1 = 0;
        //cursor for string 1
        /** @type {?} */
        let c2 = 0;
        //cursor for string 2
        /** @type {?} */
        let lcss = 0;
        //largest common subsequence
        /** @type {?} */
        let local_cs = 0;
        //local common substring
        /** @type {?} */
        let trans = 0;
        //number of transpositions ('ab' vs 'ba')
        /** @type {?} */
        let offset_arr = [];
        while ((c1 < l1) && (c2 < l2)) {
            if (s1.charAt(c1) == s2.charAt(c2)) {
                local_cs++;
                /** @type {?} */
                let isTrans = false;
                //see if current match is a transposition
                /** @type {?} */
                let i = 0;
                while (i < offset_arr.length) {
                    /** @type {?} */
                    let ofs = offset_arr[i];
                    if (c1 <= ofs.c1 || c2 <= ofs.c2) {
                        // when two matches cross, the one considered a transposition is the one with the largest difference in offsets
                        isTrans = Math.abs(c2 - c1) >= Math.abs(ofs.c2 - ofs.c1);
                        if (isTrans) {
                            trans++;
                        }
                        else {
                            if (!ofs.trans) {
                                ofs.trans = true;
                                trans++;
                            }
                        }
                        break;
                    }
                    else {
                        if (c1 > ofs.c2 && c2 > ofs.c1) {
                            offset_arr.splice(i, 1);
                        }
                        else {
                            i++;
                        }
                    }
                }
                offset_arr.push({
                    c1: c1,
                    c2: c2,
                    trans: isTrans
                });
            }
            else {
                lcss += local_cs;
                local_cs = 0;
                if (c1 != c2) {
                    c1 = c2 = Math.min(c1, c2); //using min allows the computation of transpositions
                }
                //if matching characters are found, remove 1 from both cursors (they get incremented at the end of the loop)
                //so that we can have only one code block handling matches 
                for (let j = 0; j < maxOffset && (c1 + j < l1 || c2 + j < l2); j++) {
                    if ((c1 + j < l1) && (s1.charAt(c1 + j) == s2.charAt(c2))) {
                        c1 += j - 1;
                        c2--;
                        break;
                    }
                    if ((c2 + j < l2) && (s1.charAt(c1) == s2.charAt(c2 + j))) {
                        c1--;
                        c2 += j - 1;
                        break;
                    }
                }
            }
            c1++;
            c2++;
            // this covers the case where the last match is on the last token in list, so that it can compute transpositions correctly
            if ((c1 >= l1) || (c2 >= l2)) {
                lcss += local_cs;
                local_cs = 0;
                c1 = c2 = Math.min(c1, c2);
            }
        }
        lcss += local_cs;
        return Math.round(Math.max(l1, l2) - lcss + trans); //add the cost of transpositions to the final result
    }
}
if (false) {
    /** @type {?} */
    EmailSuggestion.prototype.defaultOptions;
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1haWwtdXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC12YWxpZGF0b3JzLyIsInNvdXJjZXMiOlsiY29tcG9uZW50cy9lbWFpbC9lbWFpbC11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFZQSxrQ0FJQzs7O0lBSEcsK0JBQWtCOztJQUNsQiwwQ0FBNkI7O0lBQzdCLHVDQUF5Qjs7Ozs7QUFHN0IsbUNBS0M7OztJQUpHLHVDQUF1Qjs7SUFDdkIsMENBQTBCOztJQUMxQiwrQkFBZTs7SUFDZixnQ0FBZTs7Ozs7QUFHbkIsZ0NBSUM7OztJQUhHLDZCQUFnQjs7SUFDaEIsNEJBQWU7O0lBQ2YsMEJBQVk7Ozs7O0FBR2hCLHFCQUlDOzs7SUFIRyxvQkFBVzs7SUFDWCxvQkFBVzs7SUFDWCx1QkFBYzs7QUFHbEIsTUFBTSxPQUFPLGVBQWU7SUFBNUI7UUFFWSxtQkFBYyxHQUFpQjtZQUNuQyxPQUFPLEVBQUUsQ0FBQyxTQUFTLEVBQUUsZUFBZTtnQkFDaEMsV0FBVyxFQUFFLGFBQWEsRUFBRSxpQkFBaUI7Z0JBQzdDLGVBQWUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFlBQVk7Z0JBQ2xELFNBQVMsRUFBRSxjQUFjLEVBQUUsZ0JBQWdCO2dCQUMzQyxTQUFTLEVBQUUsWUFBWSxFQUFFLFFBQVE7Z0JBQ2pDLFNBQVMsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLFdBQVc7Z0JBQ2hELFNBQVMsRUFBRSxZQUFZLEVBQUUsYUFBYTtnQkFDdEMsZ0JBQWdCLEVBQUUsWUFBWSxFQUFFLGVBQWU7Z0JBQy9DLGVBQWUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLGdCQUFnQjtnQkFDdEQsYUFBYSxFQUFFLFNBQVMsQ0FBQztZQUM3QixrQkFBa0IsRUFBRSxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDO1lBQzFFLGVBQWUsRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLEVB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SCxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFO2dCQUMxQixJQUFJLElBQUksUUFBUSxDQUFDO2dCQUNqQixRQUFRLEdBQUcsQ0FBQyxDQUFDO2dCQUNiLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDOUI7U0FDSjtRQUNELElBQUksSUFBSSxRQUFRLENBQUM7UUFDakIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLG9EQUFvRDtJQUM1RyxDQUFDO0NBQ0o7OztJQWpQRyx5Q0FnQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcblxuLypcbiAqIENvZGUgZnJvbU1haWxjaGVjayBodHRwczovL2dpdGh1Yi5jb20vbWFpbGNoZWNrL21haWxjaGVja1xuICogQXV0aG9yXG4gKiBEZXJyaWNrIEtvIChAZGVycmlja2tvKVxuICpcbiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbiAqXG4gKiB2IDEuMS4yXG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBFbWFpbE9wdGlvbnMge1xuICAgIGRvbWFpbnM6IHN0cmluZ1tdLFxuICAgIHNlY29uZExldmVsRG9tYWluczogc3RyaW5nW10sXG4gICAgdG9wTGV2ZWxEb21haW5zOiBzdHJpbmdbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNwbGl0dGVkRW1haWwge1xuICAgIHRvcExldmVsRG9tYWluOiBzdHJpbmcsXG4gICAgc2Vjb25kTGV2ZWxEb21haW46IHN0cmluZyxcbiAgICBkb21haW46IHN0cmluZyxcbiAgICBhZGRyZXNzOiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdWdnZXN0aW9uIHtcbiAgICBhZGRyZXNzOiBzdHJpbmcsXG4gICAgZG9tYWluOiBzdHJpbmcsXG4gICAgZnVsbDogc3RyaW5nXG59XG5cbmludGVyZmFjZSBPZmZzZXQge1xuICAgIGMxOiBudW1iZXIsXG4gICAgYzI6IG51bWJlcixcbiAgICB0cmFuczogYm9vbGVhblxufVxuXG5leHBvcnQgY2xhc3MgRW1haWxTdWdnZXN0aW9uIHtcblxuICAgIHByaXZhdGUgZGVmYXVsdE9wdGlvbnM6IEVtYWlsT3B0aW9ucyA9IHtcbiAgICAgICAgZG9tYWluczogWydtc24uY29tJywgJ2JlbGxzb3V0aC5uZXQnLFxuICAgICAgICAgICAgJ3RlbHVzLm5ldCcsICdjb21jYXN0Lm5ldCcsICdvcHR1c25ldC5jb20uYXUnLFxuICAgICAgICAgICAgJ2VhcnRobGluay5uZXQnLCAncXEuY29tJywgJ3NreS5jb20nLCAnaWNsb3VkLmNvbScsXG4gICAgICAgICAgICAnbWFjLmNvbScsICdzeW1wYXRpY28uY2EnLCAnZ29vZ2xlbWFpbC5jb20nLFxuICAgICAgICAgICAgJ2F0dC5uZXQnLCAneHRyYS5jby5ueicsICd3ZWIuZGUnLFxuICAgICAgICAgICAgJ2NveC5uZXQnLCAnZ21haWwuY29tJywgJ3ltYWlsLmNvbScsICd5YWhvby5jb20nLFxuICAgICAgICAgICAgJ2FpbS5jb20nLCAncm9nZXJzLmNvbScsICd2ZXJpem9uLm5ldCcsXG4gICAgICAgICAgICAncm9ja2V0bWFpbC5jb20nLCAnZ29vZ2xlLmNvbScsICdvcHRvbmxpbmUubmV0JyxcbiAgICAgICAgICAgICdzYmNnbG9iYWwubmV0JywgJ2FvbC5jb20nLCAnbWUuY29tJywgJ2J0aW50ZXJuZXQuY29tJyxcbiAgICAgICAgICAgICdjaGFydGVyLm5ldCcsICdzaGF3LmNhJ10sXG4gICAgICAgIHNlY29uZExldmVsRG9tYWluczogW1wieWFob29cIiwgXCJob3RtYWlsXCIsIFwibWFpbFwiLCBcImxpdmVcIiwgXCJvdXRsb29rXCIsIFwiZ214XCJdLFxuICAgICAgICB0b3BMZXZlbERvbWFpbnM6IFtcImNvbVwiLCBcImNvbS5hdVwiLCBcImNvbS50d1wiLCBcImNhXCIsIFwiY28ubnpcIiwgXCJjby51a1wiLCBcImRlXCIsXG4gICAgICAgICAgICBcImZyXCIsIFwiaXRcIiwgXCJydVwiLCBcIm5ldFwiLCBcIm9yZ1wiLCBcImVkdVwiLCBcImdvdlwiLCBcImpwXCIsIFwibmxcIiwgXCJrclwiLCBcInNlXCIsIFwiZXVcIixcbiAgICAgICAgICAgIFwiaWVcIiwgXCJjby5pbFwiLCBcInVzXCIsIFwiYXRcIiwgXCJiZVwiLCBcImRrXCIsIFwiaGtcIiwgXCJlc1wiLCBcImdyXCIsIFwiY2hcIiwgXCJub1wiLCBcImN6XCIsXG4gICAgICAgICAgICBcImluXCIsIFwibmV0XCIsIFwibmV0LmF1XCIsIFwiaW5mb1wiLCBcImJpelwiLCBcIm1pbFwiLCBcImNvLmpwXCIsIFwic2dcIiwgXCJodVwiLCBcInVrXCJdXG4gICAgfVxuXG4gICAgcHVibGljIHN1Z2dlc3QoZW1haWw6IHN0cmluZywgb3B0aW9ucz86IEVtYWlsT3B0aW9ucyk6IHsgW2tleTogc3RyaW5nXTogU3VnZ2VzdGlvbiB9IHtcbiAgICAgICAgbGV0IG9wdCA9IHRoaXMuZGVmYXVsdE9wdGlvbnM7XG4gICAgICAgIGlmIChvcHRpb25zICE9IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgb3B0ID0gb3B0aW9ucztcbiAgICAgICAgfVxuICAgICAgICBsZXQgZW1haWxQYXJ0cyA9IHRoaXMuc3BsaXRFbWFpbChlbWFpbC50b0xvd2VyQ2FzZSgpKTtcblxuICAgICAgICBpZiAoIWVtYWlsUGFydHMpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0LnNlY29uZExldmVsRG9tYWlucyAmJiBvcHQudG9wTGV2ZWxEb21haW5zKSB7XG4gICAgICAgICAgICAvLyBJZiB0aGUgZW1haWwgaXMgYSB2YWxpZCAybmQtbGV2ZWwgKyB0b3AtbGV2ZWwsIGRvIG5vdCBzdWdnZXN0IGFueXRoaW5nLlxuICAgICAgICAgICAgaWYgKG9wdC5zZWNvbmRMZXZlbERvbWFpbnMuaW5kZXhPZihlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluKSAhPT0gLTEgJiYgb3B0LnRvcExldmVsRG9tYWlucy5pbmRleE9mKGVtYWlsUGFydHMudG9wTGV2ZWxEb21haW4pICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY2xvc2VzdERvbWFpbiA9IHRoaXMuZmluZENsb3Nlc3REb21haW4oZW1haWxQYXJ0cy5kb21haW4sIG9wdC5kb21haW5zLCAyKTtcbiAgICAgICAgaWYgKGNsb3Nlc3REb21haW4pIHtcbiAgICAgICAgICAgIGlmIChjbG9zZXN0RG9tYWluID09IGVtYWlsUGFydHMuZG9tYWluKSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIGVtYWlsIGFkZHJlc3MgZXhhY3RseSBtYXRjaGVzIG9uZSBvZiB0aGUgc3VwcGxpZWQgZG9tYWluczsgZG8gbm90IHJldHVybiBhIHN1Z2dlc3Rpb24uXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIGVtYWlsIGFkZHJlc3MgY2xvc2VseSBtYXRjaGVzIG9uZSBvZiB0aGUgc3VwcGxpZWQgZG9tYWluczsgcmV0dXJuIGEgc3VnZ2VzdGlvblxuICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Z2dlc3Rpb246IHsgYWRkcmVzczogZW1haWxQYXJ0cy5hZGRyZXNzLCBkb21haW46IGNsb3Nlc3REb21haW4sIGZ1bGw6IGVtYWlsUGFydHMuYWRkcmVzcyArIFwiQFwiICsgY2xvc2VzdERvbWFpbiB9IH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY2xvc2VzdFNlY29uZExldmVsRG9tYWluID0gdGhpcy5maW5kQ2xvc2VzdERvbWFpbihlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluLCBvcHQuc2Vjb25kTGV2ZWxEb21haW5zLCAyKTtcbiAgICAgICAgbGV0IGNsb3Nlc3RUb3BMZXZlbERvbWFpbiA9IHRoaXMuZmluZENsb3Nlc3REb21haW4oZW1haWxQYXJ0cy50b3BMZXZlbERvbWFpbiwgb3B0LnRvcExldmVsRG9tYWlucywgMik7XG5cbiAgICAgICAgaWYgKGVtYWlsUGFydHMuZG9tYWluKSB7XG4gICAgICAgICAgICBjbG9zZXN0RG9tYWluID0gZW1haWxQYXJ0cy5kb21haW47XG4gICAgICAgICAgICBsZXQgcnRybiA9IGZhbHNlO1xuXG4gICAgICAgICAgICBpZiAoY2xvc2VzdFNlY29uZExldmVsRG9tYWluICYmIGNsb3Nlc3RTZWNvbmRMZXZlbERvbWFpbiAhPSBlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluKSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIGVtYWlsIGFkZHJlc3MgbWF5IGhhdmUgYSBtaXNwZWxsZWQgc2Vjb25kLWxldmVsIGRvbWFpbjsgcmV0dXJuIGEgc3VnZ2VzdGlvblxuICAgICAgICAgICAgICAgIGNsb3Nlc3REb21haW4gPSBjbG9zZXN0RG9tYWluLnJlcGxhY2UoZW1haWxQYXJ0cy5zZWNvbmRMZXZlbERvbWFpbiwgY2xvc2VzdFNlY29uZExldmVsRG9tYWluKTtcbiAgICAgICAgICAgICAgICBydHJuID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNsb3Nlc3RUb3BMZXZlbERvbWFpbiAmJiBjbG9zZXN0VG9wTGV2ZWxEb21haW4gIT0gZW1haWxQYXJ0cy50b3BMZXZlbERvbWFpbiAmJiBlbWFpbFBhcnRzLnNlY29uZExldmVsRG9tYWluICE9PSAnJykge1xuICAgICAgICAgICAgICAgIC8vIFRoZSBlbWFpbCBhZGRyZXNzIG1heSBoYXZlIGEgbWlzcGVsbGVkIHRvcC1sZXZlbCBkb21haW47IHJldHVybiBhIHN1Z2dlc3Rpb25cbiAgICAgICAgICAgICAgICBjbG9zZXN0RG9tYWluID0gY2xvc2VzdERvbWFpbi5yZXBsYWNlKG5ldyBSZWdFeHAoZW1haWxQYXJ0cy50b3BMZXZlbERvbWFpbiArIFwiJFwiKSwgY2xvc2VzdFRvcExldmVsRG9tYWluKTtcbiAgICAgICAgICAgICAgICBydHJuID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJ0cm4pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWdnZXN0aW9uOiB7IGFkZHJlc3M6IGVtYWlsUGFydHMuYWRkcmVzcywgZG9tYWluOiBjbG9zZXN0RG9tYWluLCBmdWxsOiBlbWFpbFBhcnRzLmFkZHJlc3MgKyBcIkBcIiArIGNsb3Nlc3REb21haW4gfSB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyogVGhlIGVtYWlsIGFkZHJlc3MgZXhhY3RseSBtYXRjaGVzIG9uZSBvZiB0aGUgc3VwcGxpZWQgZG9tYWlucywgZG9lcyBub3QgY2xvc2VseVxuICAgICAgICAgKiBtYXRjaCBhbnkgZG9tYWluIGFuZCBkb2VzIG5vdCBhcHBlYXIgdG8gc2ltcGx5IGhhdmUgYSBtaXNwZWxsZWQgdG9wLWxldmVsIGRvbWFpbixcbiAgICAgICAgICogb3IgaXMgYW4gaW52YWxpZCBlbWFpbCBhZGRyZXNzOyBkbyBub3QgcmV0dXJuIGEgc3VnZ2VzdGlvbi5cbiAgICAgICAgICovXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG5cbiAgICB9O1xuXG4gICAgcHVibGljIHNwbGl0RW1haWwoZW1haWw6IHN0cmluZykge1xuXG4gICAgICAgIGxldCBwYXJ0cyA9IGVtYWlsLnRyaW0oKS5zcGxpdCgnQCcpO1xuXG4gICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYgKHBhcnRzW2ldID09PSAnJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVzdWx0ID0ge1xuICAgICAgICAgICAgdG9wTGV2ZWxEb21haW46IFwiXCIsXG4gICAgICAgICAgICBzZWNvbmRMZXZlbERvbWFpbjogXCJcIixcbiAgICAgICAgICAgIGRvbWFpbjogcGFydHMucG9wKCksXG4gICAgICAgICAgICBhZGRyZXNzOiAnJ1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGRvbWFpblBhcnRzID0gcmVzdWx0LmRvbWFpbi5zcGxpdCgnLicpO1xuXG4gICAgICAgIGlmIChkb21haW5QYXJ0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9tYWluUGFydHMubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICAgIHJlc3VsdC50b3BMZXZlbERvbWFpbiA9IGRvbWFpblBhcnRzWzBdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gVGhlIGFkZHJlc3MgaGFzIGEgZG9tYWluIGFuZCBhIHRvcC1sZXZlbCBkb21haW5cbiAgICAgICAgICAgIHJlc3VsdC5zZWNvbmRMZXZlbERvbWFpbiA9IGRvbWFpblBhcnRzWzBdO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBkb21haW5QYXJ0cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgIHJlc3VsdC50b3BMZXZlbERvbWFpbiArPSBkb21haW5QYXJ0c1tqXSArICcuJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdC50b3BMZXZlbERvbWFpbiA9IHJlc3VsdC50b3BMZXZlbERvbWFpbi5zdWJzdHJpbmcoMCwgcmVzdWx0LnRvcExldmVsRG9tYWluLmxlbmd0aCAtIDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVzdWx0LmFkZHJlc3MgPSBwYXJ0cy5qb2luKCdAJyk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH1cblxuICAgIHByaXZhdGUgZmluZENsb3Nlc3REb21haW4oZG9tYWluOiBzdHJpbmcsIGRvbWFpbnM6IHN0cmluZ1tdLCB0aHJlc2hvbGQ6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIGxldCBkaXN0O1xuICAgICAgICBsZXQgbWluRGlzdCA9IEluZmluaXR5O1xuICAgICAgICBsZXQgY2xvc2VzdERvbWFpbiA9IG51bGw7XG5cbiAgICAgICAgaWYgKCFkb21haW4gfHwgIWRvbWFpbnMpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRvbWFpbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmIChkb21haW4gPT09IGRvbWFpbnNbaV0pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9tYWluO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGlzdCA9IHRoaXMuc2lmdDREaXN0YW5jZShkb21haW4sIGRvbWFpbnNbaV0sIDUpO1xuICAgICAgICAgICAgaWYgKGRpc3QgPCBtaW5EaXN0KSB7XG4gICAgICAgICAgICAgICAgbWluRGlzdCA9IGRpc3Q7XG4gICAgICAgICAgICAgICAgY2xvc2VzdERvbWFpbiA9IGRvbWFpbnNbaV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWluRGlzdCA8PSB0aHJlc2hvbGQgJiYgY2xvc2VzdERvbWFpbiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIGNsb3Nlc3REb21haW47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzaWZ0NERpc3RhbmNlKHMxOiBzdHJpbmcsIHMyOiBzdHJpbmcsIG1heE9mZnNldDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgLy8gc2lmdDQ6IGh0dHBzOi8vc2lkZXJpdGUuYmxvZ3Nwb3QuY29tLzIwMTQvMTEvc3VwZXItZmFzdC1hbmQtYWNjdXJhdGUtc3RyaW5nLWRpc3RhbmNlLmh0bWxcbiAgICAgICAgaWYgKG1heE9mZnNldCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBtYXhPZmZzZXQgPSA1OyAvL2RlZmF1bHRcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghczEgfHwgIXMxLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKCFzMikge1xuICAgICAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHMyLmxlbmd0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghczIgfHwgIXMyLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIHMxLmxlbmd0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsMSA9IHMxLmxlbmd0aDtcbiAgICAgICAgbGV0IGwyID0gczIubGVuZ3RoO1xuXG4gICAgICAgIGxldCBjMSA9IDA7ICAvL2N1cnNvciBmb3Igc3RyaW5nIDFcbiAgICAgICAgbGV0IGMyID0gMDsgIC8vY3Vyc29yIGZvciBzdHJpbmcgMlxuICAgICAgICBsZXQgbGNzcyA9IDA7ICAvL2xhcmdlc3QgY29tbW9uIHN1YnNlcXVlbmNlXG4gICAgICAgIGxldCBsb2NhbF9jcyA9IDA7IC8vbG9jYWwgY29tbW9uIHN1YnN0cmluZ1xuICAgICAgICBsZXQgdHJhbnMgPSAwOyAgLy9udW1iZXIgb2YgdHJhbnNwb3NpdGlvbnMgKCdhYicgdnMgJ2JhJylcbiAgICAgICAgbGV0IG9mZnNldF9hcnI6IE9mZnNldFtdID0gW107ICAvL29mZnNldCBwYWlyIGFycmF5LCBmb3IgY29tcHV0aW5nIHRoZSB0cmFuc3Bvc2l0aW9uc1xuXG4gICAgICAgIHdoaWxlICgoYzEgPCBsMSkgJiYgKGMyIDwgbDIpKSB7XG4gICAgICAgICAgICBpZiAoczEuY2hhckF0KGMxKSA9PSBzMi5jaGFyQXQoYzIpKSB7XG4gICAgICAgICAgICAgICAgbG9jYWxfY3MrKztcbiAgICAgICAgICAgICAgICBsZXQgaXNUcmFucyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vc2VlIGlmIGN1cnJlbnQgbWF0Y2ggaXMgYSB0cmFuc3Bvc2l0aW9uXG4gICAgICAgICAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICAgICAgICAgIHdoaWxlIChpIDwgb2Zmc2V0X2Fyci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9mcyA9IG9mZnNldF9hcnJbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmIChjMSA8PSBvZnMuYzEgfHwgYzIgPD0gb2ZzLmMyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHR3byBtYXRjaGVzIGNyb3NzLCB0aGUgb25lIGNvbnNpZGVyZWQgYSB0cmFuc3Bvc2l0aW9uIGlzIHRoZSBvbmUgd2l0aCB0aGUgbGFyZ2VzdCBkaWZmZXJlbmNlIGluIG9mZnNldHNcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVHJhbnMgPSBNYXRoLmFicyhjMiAtIGMxKSA+PSBNYXRoLmFicyhvZnMuYzIgLSBvZnMuYzEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVHJhbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFucysrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9mcy50cmFucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZnMudHJhbnMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFucysrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMxID4gb2ZzLmMyICYmIGMyID4gb2ZzLmMxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0X2Fyci5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBvZmZzZXRfYXJyLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBjMTogYzEsXG4gICAgICAgICAgICAgICAgICAgIGMyOiBjMixcbiAgICAgICAgICAgICAgICAgICAgdHJhbnM6IGlzVHJhbnNcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGNzcyArPSBsb2NhbF9jcztcbiAgICAgICAgICAgICAgICBsb2NhbF9jcyA9IDA7XG4gICAgICAgICAgICAgICAgaWYgKGMxICE9IGMyKSB7XG4gICAgICAgICAgICAgICAgICAgIGMxID0gYzIgPSBNYXRoLm1pbihjMSwgYzIpOyAgLy91c2luZyBtaW4gYWxsb3dzIHRoZSBjb21wdXRhdGlvbiBvZiB0cmFuc3Bvc2l0aW9uc1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvL2lmIG1hdGNoaW5nIGNoYXJhY3RlcnMgYXJlIGZvdW5kLCByZW1vdmUgMSBmcm9tIGJvdGggY3Vyc29ycyAodGhleSBnZXQgaW5jcmVtZW50ZWQgYXQgdGhlIGVuZCBvZiB0aGUgbG9vcClcbiAgICAgICAgICAgICAgICAvL3NvIHRoYXQgd2UgY2FuIGhhdmUgb25seSBvbmUgY29kZSBibG9jayBoYW5kbGluZyBtYXRjaGVzIFxuICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWF4T2Zmc2V0ICYmIChjMSArIGogPCBsMSB8fCBjMiArIGogPCBsMik7IGorKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoKGMxICsgaiA8IGwxKSAmJiAoczEuY2hhckF0KGMxICsgaikgPT0gczIuY2hhckF0KGMyKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGMxICs9IGogLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgYzItLTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICgoYzIgKyBqIDwgbDIpICYmIChzMS5jaGFyQXQoYzEpID09IHMyLmNoYXJBdChjMiArIGopKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYzEtLTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGMyICs9IGogLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjMSsrO1xuICAgICAgICAgICAgYzIrKztcbiAgICAgICAgICAgIC8vIHRoaXMgY292ZXJzIHRoZSBjYXNlIHdoZXJlIHRoZSBsYXN0IG1hdGNoIGlzIG9uIHRoZSBsYXN0IHRva2VuIGluIGxpc3QsIHNvIHRoYXQgaXQgY2FuIGNvbXB1dGUgdHJhbnNwb3NpdGlvbnMgY29ycmVjdGx5XG4gICAgICAgICAgICBpZiAoKGMxID49IGwxKSB8fCAoYzIgPj0gbDIpKSB7XG4gICAgICAgICAgICAgICAgbGNzcyArPSBsb2NhbF9jcztcbiAgICAgICAgICAgICAgICBsb2NhbF9jcyA9IDA7XG4gICAgICAgICAgICAgICAgYzEgPSBjMiA9IE1hdGgubWluKGMxLCBjMik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGNzcyArPSBsb2NhbF9jcztcbiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoTWF0aC5tYXgobDEsIGwyKSAtIGxjc3MgKyB0cmFucyk7IC8vYWRkIHRoZSBjb3N0IG9mIHRyYW5zcG9zaXRpb25zIHRvIHRoZSBmaW5hbCByZXN1bHRcbiAgICB9XG59Il19